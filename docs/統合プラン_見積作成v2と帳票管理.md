# 見積作成v2と帳票管理統合プラン

## 📋 概要
見積作成v2と帳票管理を統合し、帳票管理画面から直接見積作成v2の機能を利用できるようにします。

---

## 🎯 実装内容

### 1. ページ構造の変更

#### 1.1 ファイル名の変更とルーティング
- **現状**: `EstimatorPageV2.tsx` が直接見積作成画面を表示
- **変更後**: 
  - `EstimatorPageV2.tsx` → `EstimatorPageV2Container.tsx` にリネーム（コンテナコンポーネントとして機能）
  - このコンテナが最初に読み込むページとして機能
  - 帳票管理画面（`DocumentManagerPage.tsx`）をデフォルト表示
  - 見積作成v2画面（`EstimatorLayoutV2.tsx`）を条件付きで表示

#### 1.2 ルーティング設定の変更
- `Routes.tsx` の `estimator-v2` ケースを修正
- `EstimatorPageV2Container` を読み込むように変更

---

### 2. ヘッダーの統合

#### 2.1 ヘッダーCSSの統一
- **帳票管理のヘッダースタイルを基準に統一**
- ヘッダー部分は帳票管理の形式を維持
- 内容は見積作成v2と帳票管理の両方の機能を維持

#### 2.2 ヘッダーコンポーネントの拡張
- `PageHeader` コンポーネントを拡張し、帳票管理のヘッダー形式に対応
- 見積作成v2モード時は保存ボタンを表示
- 帳票管理モード時は検索バーと新規作成/編集/削除ボタンを表示

---

### 3. ページ表示の流れ

```
1. 帳票管理画面（初期表示）
   ↓
2. 帳票選択時のヘッダー変更
   - 検索バーの幅を縮小
   - 新規作成、編集、削除ボタンを設置
   ↓
3. 新規作成ボタンクリック
   - 現在のタブ（見積/納品/請求/領収書）に応じて新規作成
   - 空の状態の見積作成v2画面を表示
   ↓
4. 編集ボタンクリック
   - 選択した帳票のデータを取得
   - 見積作成v2画面で編集
   ↓
5. 保存ボタンクリック
   - 帳票を更新または新規保存
   - 帳票管理画面に戻る（作成していたタブに戻る）
```

---

### 4. UI調整

#### 4.1 商品テーブルの調整
- **ファイル**: `ProcessingGroupSection.tsx` および `OrderDetailRow.tsx`
- **変更内容**:
  - 調整後単価のカラム幅: `col-span-3` → `col-span-2`
  - 品名のカラム幅: `col-span-3` → `col-span-4`
  - その他のカラムは調整（合計12カラム）

#### 4.2 カード表示の幅を統一
- **ファイル**: `EstimatorLayoutV2.tsx`
- **変更内容**:
  - 左側フォームの幅を帳票管理に合わせる: `md:col-span-5` → `md:col-span-5 lg:col-span-4`
  - 右側プレビューの幅を調整: `md:col-span-7` → `md:col-span-7 lg:col-span-8`

---

### 5. 指示書の分離

#### 5.1 指示書の除外
- 帳票管理から指示書を除外（別管理にする）
- `DocumentManagerPage.tsx` の `availableDocTypes` から `'worksheet'` を削除
- 指示書編集機能は後で別ツールとして作成予定

---

### 6. 帳票プレビューの統一

#### 6.1 プレビューコンポーネントの統一
- **ファイル**: `DocumentManagerPage.tsx` のプレビュー部分
- **変更内容**:
  - 帳票管理のプレビュー表示を見積作成v2の `PrintableEstimate` コンポーネントに統一
  - 既存のプレビュー表示ロジックを削除し、`PrintableEstimate` を使用

---

### 7. 検索バーの拡充

#### 7.1 日付フィルターの追加
- **ファイル**: `DocumentFilter.tsx` または新規コンポーネント作成
- **変更内容**:
  - 日付フィルターを追加
  - フィルタータイプ:
    - 作成日（すべての帳票タイプ）
    - 請求日（請求書のみ）
    - 納品日（納品書のみ）
    - 領収日（領収書のみ）
  - カレンダーUIで日付選択
  - 日付範囲選択（開始日〜終了日）

#### 7.2 検索バーのレイアウト調整
- 帳票選択時のヘッダーで検索バーの幅を縮小
- 新規作成、編集、削除ボタンを検索バーの横に配置

---

### 8. データフローと状態管理

#### 8.1 状態管理の追加
- コンテナコンポーネントで以下の状態を管理:
  - `currentView`: `'document-list' | 'estimator'` - 現在の表示モード
  - `editingDocumentType`: 編集中の帳票タイプ
  - `editingQuoteId`: 編集中の見積ID（編集時のみ）
  - `selectedDocType`: 選択中の帳票タイプ（タブ）

#### 8.2 保存後の遷移
- 保存成功後、帳票管理画面に戻る
- 作成していた帳票タイプのタブを自動選択
- 保存した帳票を自動選択して表示

---

## 📁 変更対象ファイル

### 新規作成
- `src/features/estimator/pages/EstimatorPageV2Container.tsx` - コンテナコンポーネント

### 変更
- `src/features/estimator/pages/EstimatorPageV2.tsx` → リネームまたは削除
- `src/features/estimator/EstimatorLayoutV2.tsx` - カード幅の調整
- `src/features/document/pages/DocumentManagerPage.tsx` - 統合ロジック追加
- `src/features/document/molecules/DocumentFilter.tsx` - 日付フィルター追加
- `src/features/estimator/organisms/ProcessingGroupSection.tsx` - テーブルカラム幅調整
- `src/shared/ui/molecules/OrderDetailRow.tsx` - テーブルカラム幅調整
- `src/core/config/Routes.tsx` - ルーティング変更

### 確認が必要なファイル
- `src/shared/ui/molecules/PageHeader.tsx` - ヘッダー拡張の確認
- `src/features/document/hooks/useDocumentData.ts` - 日付フィルター対応

---

## 🔄 実装手順

### フェーズ1: 基盤構築
1. `EstimatorPageV2Container.tsx` を作成
2. ルーティングを変更し、コンテナを経由するように修正
3. 帳票管理画面をデフォルト表示

### フェーズ2: UI統合
4. ヘッダーを帳票管理形式に統一
5. 見積作成v2のカード幅を調整
6. 商品テーブルのカラム幅を調整

### フェーズ3: 機能統合
7. 新規作成ボタンで見積作成v2画面を表示
8. 編集ボタンで見積作成v2画面を表示（データ読み込み）
9. 保存後、帳票管理画面に戻る機能を実装

### フェーズ4: プレビュー統一
10. 帳票管理のプレビューを見積作成v2のプレビューに統一

### フェーズ5: 検索機能拡充
11. 日付フィルターを追加
12. カレンダーUIを実装
13. 検索バーのレイアウト調整

### フェーズ6: 指示書の分離
14. 指示書を帳票管理から除外

---

## ⚠️ 注意事項

1. **データの整合性**
   - 編集時は既存のデータを正確に読み込む
   - 保存時は既存データを更新するか新規作成するかを適切に判断

2. **パフォーマンス**
   - 帳票管理画面の読み込み速度を維持
   - 見積作成v2画面の切り替え時のパフォーマンスに注意

3. **ユーザー体験**
   - 画面遷移がスムーズに行われるようにする
   - 保存後の遷移が自然であること

4. **バックワード互換性**
   - 既存の見積作成v2への直接アクセス経路がある場合は維持するか、リダイレクトする

---

## 🧪 テスト項目

1. 帳票管理画面が正常に表示される
2. 新規作成ボタンで見積作成v2画面が表示される
3. 編集ボタンで既存データが正しく読み込まれる
4. 保存後、帳票管理画面に戻り、適切なタブが選択される
5. 日付フィルターが正常に機能する
6. プレビューが正常に表示される
7. 商品テーブルのカラム幅が適切に調整されている
8. カード表示の幅が帳票管理と統一されている

---

## 📝 補足

- 指示書は別ツールとして後で作成予定（指示書メーカーとイメージ画像作成ツールと組み合わせる）
- ヘッダーのCSSは帳票管理の形式を基準に統一するが、機能は両方の機能を維持
- 検索バーの日付フィルターは段階的に実装（まずは基本的な日付選択から）

