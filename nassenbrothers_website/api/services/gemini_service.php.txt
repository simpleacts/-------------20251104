<?php
// api/services/gemini_service.php.txt

/**
 * Gemini APIとの通信ロジックをカプセル化するサービスファイル。
 * このファイルは直接呼び出されることを想定しておらず、
 * gemini_proxy.php や他のバックエンドスクリプトから require されます。
 */

// このファイルが直接アクセスされた場合に備えて、設定ファイルを読み込む
if (!defined('GEMINI_API_KEY')) {
    require_once __DIR__ . '/../db_connect.php';
    // db_connect.php 内の関数を呼び出して定数を定義
    load_server_config();
}

/**
 * Gemini APIを呼び出す共通関数
 * @param array $payload フロントエンドから受け取ったリクエストボディ
 * @return string Gemini APIからのレスポンスボディ (JSON文字列)
 * @throws Exception 通信エラーやAPIからのエラーレスポンスが発生した場合
 */
function call_gemini_api(array $payload): string {
    if (!defined('GEMINI_API_KEY') || GEMINI_API_KEY === '' || strpos(GEMINI_API_KEY, 'ここに') !== false) {
        throw new Exception('Gemini API key is not configured on the server.', 500);
    }
    
    if (!isset($payload['model'])) {
        throw new Exception('Payload must contain a "model" key.', 400);
    }
    
    $model = $payload['model'];
    $api_key = GEMINI_API_KEY;
    
    // モデルに応じてエンドポイントを動的に決定
    $endpoint_action = "generateContent";
    if (strpos($model, 'imagen') !== false) {
        $endpoint_action = "generateImages";
    }
    
    $url = "https://generativelanguage.googleapis.com/v1beta/models/{$model}:{$endpoint_action}?key={$api_key}";
    
    $request_body = json_encode($payload);
    if ($request_body === false) {
        throw new Exception('Failed to re-encode JSON payload.', 500);
    }
    
    // cURLを使用してリクエストを送信
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $url);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_POST, true);
    curl_setopt($ch, CURLOPT_POSTFIELDS, $request_body);
    curl_setopt($ch, CURLOPT_HTTPHEADER, [
        'Content-Type: application/json',
        'Content-Length: ' . strlen($request_body)
    ]);
    curl_setopt($ch, CURLOPT_TIMEOUT, 120);

    $response_body = curl_exec($ch);
    $http_code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    $curl_error = curl_error($ch);
    curl_close($ch);

    if ($response_body === false || $http_code >= 400) {
        $error_message = "cURL error to Gemini API: {$curl_error} (HTTP Code: {$http_code}). Response: {$response_body}";
        error_log($error_message);
        throw new Exception("AIサービスとの通信に失敗しました。", $http_code >= 400 ? $http_code : 502);
    }

    return $response_body;
}
?>