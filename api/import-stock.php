<?php
// This file will be renamed to import-stock.php on the server.
// エラー表示を抑制（JSONレスポンスを壊さないため）
error_reporting(E_ALL);
ini_set('display_errors', 0);
ini_set('log_errors', 1);

// 大量データ処理に対応するための設定
// 実行時間制限を10分（600秒）に設定（0は無制限だが、セキュリティのため制限を設ける）
set_time_limit(600);
// メモリ制限を512MBに設定（大量データ処理に対応）
ini_set('memory_limit', '512M');

header('Content-Type: application/json; charset=utf-8');
require_once 'db_connect.php'; // $pdo is available
require_once 'validation_utils.php'; // データ検証ユーティリティ
require_once 'schema_utils.php'; // スキーマユーティリティ（tableExists関数など）

// --- Helper Functions ---

/**
 * メーカーごとの在庫テーブル（manu_{manufacturer_id}_stock）が存在するか確認し、存在しない場合は作成
 */
function ensureStockTable(&$pdo, $manufacturer_id) {
    $table_name = "{$manufacturer_id}_stock";
    
    // テーブルが存在するか確認（schema_utils.phpのtableExists関数を使用）
    if (tableExists($pdo, $table_name)) {
        // 既存テーブルに新しいカラムを追加（存在しない場合のみ）
        $columns_to_add = [
            'category_id' => "VARCHAR(255)",
            'is_published' => "TINYINT(1) DEFAULT 0",
            'brand_id' => "VARCHAR(255)"
        ];
        
        foreach ($columns_to_add as $column_name => $column_def) {
            $stmt_check = $pdo->prepare("SHOW COLUMNS FROM `{$table_name}` LIKE ?");
            $stmt_check->execute([$column_name]);
            if ($stmt_check->rowCount() === 0) {
                try {
                    $pdo->exec("ALTER TABLE `{$table_name}` ADD COLUMN `{$column_name}` {$column_def}");
                } catch (Exception $e) {
                    // カラム追加に失敗した場合はログに記録して続行
                    error_log("Failed to add column {$column_name} to {$table_name}: " . $e->getMessage());
                }
            }
        }
        
        // インデックスの追加（存在しない場合のみ）
        $indexes_to_add = [
            'idx_category' => "(`manufacturer_id`, `product_code`, `category_id`)",
            'idx_brand' => "(`manufacturer_id`, `product_code`, `brand_id`)"
        ];
        
        foreach ($indexes_to_add as $index_name => $index_def) {
            $stmt_check = $pdo->prepare("SHOW INDEX FROM `{$table_name}` WHERE Key_name = ?");
            $stmt_check->execute([$index_name]);
            if ($stmt_check->rowCount() === 0) {
                try {
                    $pdo->exec("ALTER TABLE `{$table_name}` ADD INDEX `{$index_name}` {$index_def}");
                } catch (Exception $e) {
                    // インデックス追加に失敗した場合はログに記録して続行
                    error_log("Failed to add index {$index_name} to {$table_name}: " . $e->getMessage());
                }
            }
        }
        
        return $table_name; // テーブルが既に存在する
    }
    
    // テーブルが存在しない場合は作成
    $create_table_sql = "
        CREATE TABLE `{$table_name}` (
            `id` VARCHAR(255) NOT NULL,
            `manufacturer_id` VARCHAR(255) NOT NULL,
            `product_code` VARCHAR(255) NOT NULL,
            `stock_product_name` TEXT,
            `color_code` VARCHAR(255) NOT NULL,
            `color_name` VARCHAR(255),
            `size_code` VARCHAR(255) NOT NULL,
            `size_name` VARCHAR(255),
            `quantity` INT DEFAULT 0,
            `incoming_quantity_1` INT DEFAULT 0,
            `incoming_date_1` DATE,
            `incoming_quantity_2` INT DEFAULT 0,
            `incoming_date_2` DATE,
            `incoming_quantity_3` INT DEFAULT 0,
            `incoming_date_3` DATE,
            `category_id` VARCHAR(255),
            `is_published` TINYINT(1) DEFAULT 0,
            `brand_id` VARCHAR(255),
            `list_price` INT,
            `cost_price` INT,
            `jan_code` VARCHAR(255),
            `created_at` DATETIME,
            `updated_at` DATETIME,
            PRIMARY KEY (`id`),
            UNIQUE KEY `unique_sku` (`manufacturer_id`, `product_code`, `color_code`, `size_code`),
            INDEX `idx_product` (`manufacturer_id`, `product_code`),
            INDEX `idx_color` (`manufacturer_id`, `product_code`, `color_code`),
            INDEX `idx_size` (`manufacturer_id`, `product_code`, `color_code`, `size_code`),
            INDEX `idx_category` (`manufacturer_id`, `product_code`, `category_id`),
            INDEX `idx_brand` (`manufacturer_id`, `product_code`, `brand_id`)
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci
    ";
    
    $pdo->exec($create_table_sql);
    return $table_name;
}

/**
 * 自動生成カラムを記録する（カラム単位で編集可否を管理）
 */
function recordAutoGeneratedColumn(&$pdo, $table_name, $column_name, $manufacturer_id, $source_table, $source_column = null) {
    try {
        // auto_generated_columnsテーブルが存在するか確認
        $stmt_check = $pdo->prepare("SHOW TABLES LIKE 'auto_generated_columns'");
        $stmt_check->execute();
        if ($stmt_check->rowCount() === 0) {
            // テーブルが存在しない場合は作成
            $create_meta_sql = "
                CREATE TABLE `auto_generated_columns` (
                    `table_name` VARCHAR(255) NOT NULL,
                    `column_name` VARCHAR(255) NOT NULL,
                    `manufacturer_id` VARCHAR(255) NOT NULL,
                    `source_table` VARCHAR(255) NOT NULL,
                    `source_column` VARCHAR(255),
                    `created_at` DATETIME,
                    PRIMARY KEY (`table_name`, `column_name`),
                    INDEX `idx_manufacturer` (`manufacturer_id`),
                    INDEX `idx_source` (`source_table`),
                    INDEX `idx_table` (`table_name`)
                ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci
            ";
            $pdo->exec($create_meta_sql);
        }
        
        // 既に記録されているか確認
        $stmt_existing = $pdo->prepare("SELECT table_name, column_name FROM `auto_generated_columns` WHERE table_name = ? AND column_name = ?");
        $stmt_existing->execute([$table_name, $column_name]);
        if ($stmt_existing->rowCount() === 0) {
            // 新規記録
            $now = date('Y-m-d H:i:s');
            $stmt_insert = $pdo->prepare("
                INSERT INTO `auto_generated_columns` (table_name, column_name, manufacturer_id, source_table, source_column, created_at)
                VALUES (?, ?, ?, ?, ?, ?)
            ");
            $stmt_insert->execute([$table_name, $column_name, $manufacturer_id, $source_table, $source_column, $now]);
        }
    } catch (PDOException $e) {
        // エラーをログに記録するが、処理は続行
        error_log("[import-stock.php] Failed to record auto-generated column '{$table_name}.{$column_name}': " . $e->getMessage());
    }
}

/**
 * 商品詳細テーブル（manu_{manufacturer_id}_details）に商品を登録
 * 注意: products_masterテーブルは削除（stockテーブルに統合）
 * スキーマ変更: product_id → id（主キー）+ manufacturer_id + product_code（UNIQUE制約）
 */
function ensureProductDetails(&$pdo, $manufacturer_id, $product_code, $product_name, $source_table = null) {
    $details_table_name = "{$manufacturer_id}_details";
    // テーブルが存在するか確認（schema_utils.phpのtableExists関数を使用）
    $details_table_existed = tableExists($pdo, $details_table_name);
    
    if (!$details_table_existed) {
        // テーブルが存在しない場合は作成（idを主キーに、manufacturer_id + product_codeはUNIQUE制約）
        // tagsフィールドを追加（JSON配列としてtag_idを保存）
        // productNameはstock_product_nameに対応、product_nameは略称用
        $create_details_sql = "
            CREATE TABLE `{$details_table_name}` (
                `id` VARCHAR(255) NOT NULL,
                `manufacturer_id` VARCHAR(255) NOT NULL,
                `product_code` VARCHAR(255) NOT NULL,
                `productName` TEXT,
                `product_name` TEXT,
                `description` TEXT,
                `images` TEXT,
                `tags` TEXT,
                `brand` VARCHAR(255),
                `meta_title` TEXT,
                `meta_description` TEXT,
                `og_image_url` TEXT,
                `og_title` TEXT,
                `og_description` TEXT,
                PRIMARY KEY (`id`),
                UNIQUE KEY `unique_product` (`manufacturer_id`, `product_code`),
                INDEX `idx_product_code` (`product_code`),
                INDEX `idx_manufacturer` (`manufacturer_id`),
                INDEX `idx_brand` (`brand`)
            ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci
        ";
        $pdo->exec($create_details_sql);
        
        // 自動生成カラムとして記録（source_tableが指定されている場合のみ）
        if ($source_table) {
            // stockから自動生成されるカラムを記録
            recordAutoGeneratedColumn($pdo, $details_table_name, 'product_code', $manufacturer_id, $source_table, 'product_code');
            recordAutoGeneratedColumn($pdo, $details_table_name, 'manufacturer_id', $manufacturer_id, $source_table, 'manufacturer_id');
            recordAutoGeneratedColumn($pdo, $details_table_name, 'productName', $manufacturer_id, $source_table, 'stock_product_name');
            // description, images, meta_title, meta_description, og_image_url, og_title, og_description は手動編集可能なので記録しない
        }
    } else {
        // 既存テーブルの場合、product_idカラムをproduct_codeに変更
        // まず、product_codeカラムが存在するか確認
        $stmt_check = $pdo->prepare("SHOW COLUMNS FROM `{$details_table_name}` LIKE 'product_code'");
        $stmt_check->execute();
        $has_product_code = $stmt_check->rowCount() > 0;
        
        if (!$has_product_code) {
            // product_idカラムが存在するか確認
            $stmt_check = $pdo->prepare("SHOW COLUMNS FROM `{$details_table_name}` LIKE 'product_id'");
            $stmt_check->execute();
            $has_product_id = $stmt_check->rowCount() > 0;
            
            if ($has_product_id) {
                // product_idカラムをproduct_codeに変更（データ移行）
                try {
                    // 一時的にmanufacturer_idとproduct_codeカラムを追加
                    $pdo->exec("ALTER TABLE `{$details_table_name}` ADD COLUMN `manufacturer_id` VARCHAR(255) AFTER `product_id`");
                    $pdo->exec("ALTER TABLE `{$details_table_name}` ADD COLUMN `product_code` VARCHAR(255) AFTER `manufacturer_id`");
                    
                    // product_idからmanufacturer_idとproduct_codeを抽出（prod_{manufacturer_id}_{product_code}形式から）
                    $pdo->exec("
                        UPDATE `{$details_table_name}` 
                        SET `manufacturer_id` = SUBSTRING(`product_id`, LOCATE('_', `product_id`) + 1, LOCATE('_', `product_id`, LOCATE('_', `product_id`) + 1) - LOCATE('_', `product_id`) - 1),
                            `product_code` = SUBSTRING(`product_id`, LOCATE('_', `product_id`, LOCATE('_', `product_id`) + 1) + 1)
                        WHERE `product_id` LIKE 'prod_%_%'
                    ");
                    
                    // idカラムを追加（brands、stock、tagsと同様にidを主キーに）
                    $pdo->exec("ALTER TABLE `{$details_table_name}` ADD COLUMN `id` VARCHAR(255) NOT NULL FIRST");
                    // product_idからidを生成（product_idをそのままidとして使用）
                    $pdo->exec("UPDATE `{$details_table_name}` SET `id` = `product_id`");
                    
                    // 主キーを変更（idを主キーに、manufacturer_id + product_codeはUNIQUE制約）
                    $pdo->exec("ALTER TABLE `{$details_table_name}` DROP PRIMARY KEY");
                    $pdo->exec("ALTER TABLE `{$details_table_name}` ADD PRIMARY KEY (`id`)");
                    $pdo->exec("ALTER TABLE `{$details_table_name}` ADD UNIQUE KEY `unique_product` (`manufacturer_id`, `product_code`)");
                    
                    // product_idカラムを削除
                    $pdo->exec("ALTER TABLE `{$details_table_name}` DROP COLUMN `product_id`");
                } catch (Exception $e) {
                    // エラーが発生した場合はログに記録して続行
                    error_log("Failed to migrate product_id to manufacturer_id + product_code in {$details_table_name}: " . $e->getMessage());
                }
            } else {
                // product_idカラムが存在しない場合、id、manufacturer_id、product_codeカラムを追加
                try {
                    // idカラムを追加（manufacturer_id + product_codeから生成）
                    $pdo->exec("ALTER TABLE `{$details_table_name}` ADD COLUMN `id` VARCHAR(255) NOT NULL FIRST");
                    $pdo->exec("ALTER TABLE `{$details_table_name}` ADD COLUMN `manufacturer_id` VARCHAR(255) NOT NULL AFTER `id`");
                    $pdo->exec("ALTER TABLE `{$details_table_name}` ADD COLUMN `product_code` VARCHAR(255) NOT NULL AFTER `manufacturer_id`");
                    // idを生成（manufacturer_id + product_codeから）
                    $pdo->exec("UPDATE `{$details_table_name}` SET `id` = CONCAT('prod_', `manufacturer_id`, '_', `product_code`) WHERE `id` IS NULL OR `id` = ''");
                    $pdo->exec("ALTER TABLE `{$details_table_name}` DROP PRIMARY KEY");
                    $pdo->exec("ALTER TABLE `{$details_table_name}` ADD PRIMARY KEY (`id`)");
                    $pdo->exec("ALTER TABLE `{$details_table_name}` ADD UNIQUE KEY `unique_product` (`manufacturer_id`, `product_code`)");
                } catch (Exception $e) {
                    error_log("Failed to add id, manufacturer_id and product_code to {$details_table_name}: " . $e->getMessage());
                }
            }
        }
        
        // idカラムが存在しない場合（既存テーブルでproduct_codeがあるがidがない場合）
        $stmt_check_id = $pdo->prepare("SHOW COLUMNS FROM `{$details_table_name}` LIKE 'id'");
        $stmt_check_id->execute();
        if ($stmt_check_id->rowCount() === 0) {
            try {
                // idカラムを追加
                $pdo->exec("ALTER TABLE `{$details_table_name}` ADD COLUMN `id` VARCHAR(255) NOT NULL FIRST");
                // manufacturer_id + product_codeからidを生成
                $pdo->exec("UPDATE `{$details_table_name}` SET `id` = CONCAT('prod_', `manufacturer_id`, '_', `product_code`) WHERE `id` IS NULL OR `id` = ''");
                // 主キーを変更（idを主キーに、manufacturer_id + product_codeはUNIQUE制約）
                $pdo->exec("ALTER TABLE `{$details_table_name}` DROP PRIMARY KEY");
                $pdo->exec("ALTER TABLE `{$details_table_name}` ADD PRIMARY KEY (`id`)");
                $pdo->exec("ALTER TABLE `{$details_table_name}` ADD UNIQUE KEY `unique_product` (`manufacturer_id`, `product_code`)");
            } catch (Exception $e) {
                error_log("Failed to add id column to {$details_table_name}: " . $e->getMessage());
            }
        }
        
        // tagsカラムが存在するか確認し、存在しない場合は追加
        $stmt_check_tags = $pdo->prepare("SHOW COLUMNS FROM `{$details_table_name}` LIKE 'tags'");
        $stmt_check_tags->execute();
        if ($stmt_check_tags->rowCount() === 0) {
            try {
                $pdo->exec("ALTER TABLE `{$details_table_name}` ADD COLUMN `tags` TEXT AFTER `images`");
            } catch (Exception $e) {
                error_log("Failed to add tags column to {$details_table_name}: " . $e->getMessage());
            }
        }
    }
    
    // 半角カナを全角に変換、全角英数字を半角に変換、全角スペースを半角に変換
    // K: 半角カナ→全角カナ, V: 濁点・半濁点変換, r: 全角英数字→半角英数字, s: 全角スペース→半角スペース
    $product_name_fullwidth = mb_convert_kana($product_name, 'KVrs', 'UTF-8');
    // idを生成（manufacturer_id + product_codeから）
    $product_details_id = "prod_{$manufacturer_id}_{$product_code}";
    $stmt_details_insert = $pdo->prepare("
        INSERT INTO `{$details_table_name}` (id, manufacturer_id, product_code, productName, tags)
        VALUES (?, ?, ?, ?, NULL)
        ON DUPLICATE KEY UPDATE productName = VALUES(productName)
    ");
    $stmt_details_insert->execute([$product_details_id, $manufacturer_id, $product_code, $product_name_fullwidth]);
    
    return $product_code;
}

/**
 * メーカーごとのカラーテーブル（colors_{manufacturer_id}）にカラーを登録
 * 同じコード（color_code）であれば、カラー名も統一されている前提で処理
 * 重複するもの（同じコード）はスキップする
 */
function ensureColor(&$pdo, $manufacturer_id, $color_code, $color_name, $source_table = null) {
    $table_name = "colors_{$manufacturer_id}";
    
    // テーブルが存在するか確認（schema_utils.phpのtableExists関数を使用）
    $table_existed = tableExists($pdo, $table_name);
    
    if (!$table_existed) {
        // テーブルが存在しない場合は作成（colorCode, colorName, colorType, hexカラムを使用）
        $create_table_sql = "
            CREATE TABLE `{$table_name}` (
                `id` VARCHAR(255) NOT NULL,
                `manufacturer_id` VARCHAR(255) NOT NULL,
                `colorCode` VARCHAR(255) NOT NULL,
                `colorName` VARCHAR(255),
                `colorType` VARCHAR(255),
                `hex` VARCHAR(255),
                PRIMARY KEY (`id`),
                UNIQUE KEY `unique_code` (`manufacturer_id`, `colorCode`)
            ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci
        ";
        $pdo->exec($create_table_sql);
        
        // 自動生成カラムとして記録（source_tableが指定されている場合のみ）
        if ($source_table) {
            // stockから自動生成されるカラムを記録
            recordAutoGeneratedColumn($pdo, $table_name, 'id', $manufacturer_id, $source_table, null);
            recordAutoGeneratedColumn($pdo, $table_name, 'colorCode', $manufacturer_id, $source_table, 'color_code');
            recordAutoGeneratedColumn($pdo, $table_name, 'colorName', $manufacturer_id, $source_table, 'color_name');
            recordAutoGeneratedColumn($pdo, $table_name, 'manufacturer_id', $manufacturer_id, $source_table, 'manufacturer_id');
            // colorType, hex は手動編集可能なので記録しない
        }
    }
    
    // カラーIDを生成
    $color_id = "color_{$manufacturer_id}_{$color_code}";
    
    // 既に存在するか確認（コードで重複チェック）- colorCodeを使用
    // 後方互換性のため、codeカラムが存在する場合はそれもチェック
    $stmt_check = $pdo->prepare("SHOW COLUMNS FROM `{$table_name}` LIKE 'colorCode'");
    $stmt_check->execute();
    $hasColorCode = $stmt_check->rowCount() > 0;
    
    if ($hasColorCode) {
        // 新しいカラム名（colorCode, colorName）を使用
        $stmt_check = $pdo->prepare("SELECT id, colorName FROM `{$table_name}` WHERE manufacturer_id = ? AND colorCode = ? LIMIT 1");
        $stmt_check->execute([$manufacturer_id, $color_code]);
        $existing = $stmt_check->fetch();
        
        if (!$existing) {
            // 新規登録（重複なし）
            $stmt_insert = $pdo->prepare("
                INSERT INTO `{$table_name}` (id, manufacturer_id, colorCode, colorName)
                VALUES (?, ?, ?, ?)
            ");
            $stmt_insert->execute([$color_id, $manufacturer_id, $color_code, $color_name]);
        }
    } else {
        // 古いカラム名（code, name）を使用（後方互換性）
        $stmt_check = $pdo->prepare("SELECT id, name FROM `{$table_name}` WHERE manufacturer_id = ? AND code = ? LIMIT 1");
        $stmt_check->execute([$manufacturer_id, $color_code]);
        $existing = $stmt_check->fetch();
        
        if (!$existing) {
            // 新規登録（重複なし）
            $stmt_insert = $pdo->prepare("
                INSERT INTO `{$table_name}` (id, manufacturer_id, code, name)
                VALUES (?, ?, ?, ?)
            ");
            $stmt_insert->execute([$color_id, $manufacturer_id, $color_code, $color_name]);
        }
    }
    
    return $color_id;
}

/**
 * メーカーごとのサイズテーブル（sizes_{manufacturer_id}）にサイズを登録
 * 同じコード（size_code）であれば、サイズ名も統一されている前提で処理
 * 重複するもの（同じコード）はスキップする
 */
function ensureSize(&$pdo, $manufacturer_id, $size_code, $size_name, $source_table = null) {
    $table_name = "sizes_{$manufacturer_id}";
    
    // テーブルが存在するか確認（schema_utils.phpのtableExists関数を使用）
    $table_existed = tableExists($pdo, $table_name);
    
    if (!$table_existed) {
        // テーブルが存在しない場合は作成（sizeCode, sizeNameを使用）
        $create_table_sql = "
            CREATE TABLE `{$table_name}` (
                `id` VARCHAR(255) NOT NULL,
                `manufacturer_id` VARCHAR(255) NOT NULL,
                `sizeCode` VARCHAR(255) NOT NULL,
                `sizeName` VARCHAR(255),
                PRIMARY KEY (`id`),
                UNIQUE KEY `unique_code` (`manufacturer_id`, `sizeCode`)
            ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci
        ";
        $pdo->exec($create_table_sql);
        
        // 自動生成カラムとして記録（source_tableが指定されている場合のみ）
        if ($source_table) {
            // stockから自動生成されるカラムを記録
            recordAutoGeneratedColumn($pdo, $table_name, 'id', $manufacturer_id, $source_table, null);
            recordAutoGeneratedColumn($pdo, $table_name, 'sizeCode', $manufacturer_id, $source_table, 'size_code');
            recordAutoGeneratedColumn($pdo, $table_name, 'sizeName', $manufacturer_id, $source_table, 'size_name');
            recordAutoGeneratedColumn($pdo, $table_name, 'manufacturer_id', $manufacturer_id, $source_table, 'manufacturer_id');
        }
    }
    
    // サイズIDを生成
    $size_id = "size_{$manufacturer_id}_{$size_code}";
    
    // 既に存在するか確認（コードで重複チェック）- sizeCodeを使用
    $stmt_check = $pdo->prepare("SELECT id, sizeName FROM `{$table_name}` WHERE manufacturer_id = ? AND sizeCode = ? LIMIT 1");
    $stmt_check->execute([$manufacturer_id, $size_code]);
    $existing = $stmt_check->fetch();
    
    if (!$existing) {
        // 新規登録（重複なし）- sizeCode, sizeNameを使用
        $stmt_insert = $pdo->prepare("
            INSERT INTO `{$table_name}` (id, manufacturer_id, sizeCode, sizeName)
            VALUES (?, ?, ?, ?)
        ");
        $stmt_insert->execute([$size_id, $manufacturer_id, $size_code, $size_name]);
    } else {
        // 既存レコードがある場合はスキップ（重複）
        // 同じコードであれば名前も統一されている前提のため、既存の名前を優先
        // もし名前が異なる場合は、既存の名前を維持（更新しない）
    }
    
    return $size_id;
}

/**
 * メーカーごとの入荷予定テーブル（incoming_stock_{manufacturer_id}）が存在するか確認し、存在しない場合は作成
 */
function ensureIncomingStockTable(&$pdo, $manufacturer_id) {
    $table_name = "incoming_stock_{$manufacturer_id}";
    
    // テーブルが存在するか確認（schema_utils.phpのtableExists関数を使用）
    if (tableExists($pdo, $table_name)) {
        return $table_name; // テーブルが既に存在する
    }
    
    // テーブルが存在しない場合は作成
    $create_table_sql = "
        CREATE TABLE `{$table_name}` (
            `id` VARCHAR(255) NOT NULL,
            `sku_id` VARCHAR(255),
            `manufacturer_id` VARCHAR(255),
            `quantity_1` INT,
            `arrival_date_1` DATE,
            `quantity_2` INT,
            `arrival_date_2` DATE,
            `quantity_3` INT,
            `arrival_date_3` DATE,
            PRIMARY KEY (`id`),
            INDEX `idx_manufacturer` (`manufacturer_id`),
            INDEX `idx_sku` (`sku_id`)
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci
    ";
    
    $pdo->exec($create_table_sql);
    return $table_name;
}

/**
 * メーカーごとの商品カラーテーブル（product_colors_{manufacturer_id}）が存在するか確認し、存在しない場合は作成
 */
function ensureProductColorsTable(&$pdo, $manufacturer_id) {
    $table_name = "product_colors_{$manufacturer_id}";
    
    // テーブルが存在するか確認（schema_utils.phpのtableExists関数を使用）
    if (tableExists($pdo, $table_name)) {
        return $table_name; // テーブルが既に存在する
    }
    
    // テーブルが存在しない場合は作成
    $create_table_sql = "
        CREATE TABLE `{$table_name}` (
            `product_id` VARCHAR(255) NOT NULL,
            `color_id` VARCHAR(255) NOT NULL,
            `manufacturer_id` VARCHAR(255),
            PRIMARY KEY (`product_id`, `color_id`),
            INDEX `idx_product` (`product_id`),
            INDEX `idx_color` (`color_id`),
            INDEX `idx_manufacturer` (`manufacturer_id`)
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci
    ";
    
    $pdo->exec($create_table_sql);
    return $table_name;
}

/**
 * メーカーごとの商品サイズテーブル（product_sizes_{manufacturer_id}）が存在するか確認し、存在しない場合は作成
 */
function ensureProductSizesTable(&$pdo, $manufacturer_id) {
    $table_name = "product_sizes_{$manufacturer_id}";
    
    // テーブルが存在するか確認（schema_utils.phpのtableExists関数を使用）
    if (tableExists($pdo, $table_name)) {
        return $table_name; // テーブルが既に存在する
    }
    
    // テーブルが存在しない場合は作成
    $create_table_sql = "
        CREATE TABLE `{$table_name}` (
            `id` VARCHAR(255) NOT NULL,
            `manufacturer_id` VARCHAR(255) NOT NULL,
            `product_id` VARCHAR(255),
            `size_id` VARCHAR(255),
            `sort_order` INT,
            PRIMARY KEY (`id`),
            INDEX `idx_product_sizes_product` (`product_id`),
            INDEX `idx_product_sizes_size` (`size_id`),
            INDEX `idx_product_sizes_manufacturer` (`manufacturer_id`)
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci
    ";
    
    $pdo->exec($create_table_sql);
    return $table_name;
}

/**
 * メーカーごとの商品カラーサイズテーブル（product_color_sizes_{manufacturer_id}）が存在するか確認し、存在しない場合は作成
 */
function ensureProductColorSizesTable(&$pdo, $manufacturer_id) {
    $table_name = "product_color_sizes_{$manufacturer_id}";
    
    // テーブルが存在するか確認（schema_utils.phpのtableExists関数を使用）
    if (tableExists($pdo, $table_name)) {
        return $table_name; // テーブルが既に存在する
    }
    
    // テーブルが存在しない場合は作成
    $create_table_sql = "
        CREATE TABLE `{$table_name}` (
            `id` VARCHAR(255) NOT NULL,
            `manufacturer_id` VARCHAR(255),
            `product_id` VARCHAR(255),
            `color_id` VARCHAR(255),
            `size_id` VARCHAR(255),
            `sort_order` INT,
            PRIMARY KEY (`id`),
            INDEX `idx_product_color_sizes_product` (`product_id`),
            INDEX `idx_product_color_sizes_color` (`color_id`),
            INDEX `idx_product_color_sizes_size` (`size_id`),
            INDEX `idx_product_color_sizes_manufacturer` (`manufacturer_id`),
            INDEX `idx_product_color_sizes_product_color` (`product_id`, `color_id`)
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci
    ";
    
    $pdo->exec($create_table_sql);
    return $table_name;
}

/**
 * メーカーごとのSKUテーブル（skus_{manufacturer_id}）が存在するか確認し、存在しない場合は作成
 */
function ensureSkusTable(&$pdo, $manufacturer_id) {
    $table_name = "skus_{$manufacturer_id}";
    
    // テーブルが存在するか確認（schema_utils.phpのtableExists関数を使用）
    if (tableExists($pdo, $table_name)) {
        return $table_name; // テーブルが既に存在する
    }
    
    // テーブルが存在しない場合は作成
    $create_table_sql = "
        CREATE TABLE `{$table_name}` (
            `id` VARCHAR(255) NOT NULL,
            `product_master_id` VARCHAR(255),
            `color_id` VARCHAR(255),
            `size_id` VARCHAR(255),
            `jan_code` VARCHAR(255),
            `manufacturer_id` VARCHAR(255),
            PRIMARY KEY (`id`),
            INDEX `idx_product_master` (`product_master_id`),
            INDEX `idx_color` (`color_id`),
            INDEX `idx_size` (`size_id`),
            INDEX `idx_manufacturer` (`manufacturer_id`)
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci
    ";
    
    $pdo->exec($create_table_sql);
    return $table_name;
}

/**
 * メーカーごとの商品価格テーブル（product_prices_{manufacturer_id}）が存在するか確認し、存在しない場合は作成
 */
function ensureProductPricesTable(&$pdo, $manufacturer_id) {
    $table_name = "product_prices_{$manufacturer_id}";
    
    // テーブルが存在するか確認（schema_utils.phpのtableExists関数を使用）
    if (tableExists($pdo, $table_name)) {
        return $table_name; // テーブルが既に存在する
    }
    
    // テーブルが存在しない場合は作成
    $create_table_sql = "
        CREATE TABLE `{$table_name}` (
            `id` INT NOT NULL AUTO_INCREMENT,
            `productId` VARCHAR(255),
            `price_group_item_id` INT,
            `size` VARCHAR(255),
            `listPrice` INT,
            `purchasePrice` INT,
            `manufacturer_id` VARCHAR(255),
            PRIMARY KEY (`id`),
            INDEX `idx_product` (`productId`),
            INDEX `idx_manufacturer` (`manufacturer_id`)
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci
    ";
    
    $pdo->exec($create_table_sql);
    return $table_name;
}

/**
 * メーカーごとのタグマスターテーブル（tags_{manufacturer_id}）が存在するか確認し、存在しない場合は作成
 * 注意: product_tags_manu_xxxxは削除（product_details_manu_xxxxのtagsフィールドで管理）
 * tags_manu_xxxxはメーカー依存のタグマスターテーブルとして使用
 */
function ensureTagsTable(&$pdo, $manufacturer_id) {
    $table_name = "tags_{$manufacturer_id}";
    
    // テーブルが存在するか確認（schema_utils.phpのtableExists関数を使用）
    $table_existed = tableExists($pdo, $table_name);
    
    if (!$table_existed) {
        // テーブルが存在しない場合は作成（brandsと同じスキーマ: id, manufacturer_id, name）
        $create_table_sql = "
            CREATE TABLE `{$table_name}` (
                `id` VARCHAR(255) NOT NULL,
                `manufacturer_id` VARCHAR(255) NOT NULL,
                `name` VARCHAR(255) NOT NULL,
                PRIMARY KEY (`id`),
                INDEX `idx_manufacturer` (`manufacturer_id`),
                UNIQUE KEY `unique_name` (`manufacturer_id`, `name`)
            ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci
        ";
        
        $pdo->exec($create_table_sql);
    } else {
        // 既存テーブルの場合、colorとdescriptionカラムを削除（brandsと同じスキーマに統一）
        try {
            // colorカラムが存在する場合は削除
            $stmt_check = $pdo->prepare("SHOW COLUMNS FROM `{$table_name}` LIKE 'color'");
            $stmt_check->execute();
            if ($stmt_check->rowCount() > 0) {
                $pdo->exec("ALTER TABLE `{$table_name}` DROP COLUMN `color`");
            }
            
            // descriptionカラムが存在する場合は削除
            $stmt_check = $pdo->prepare("SHOW COLUMNS FROM `{$table_name}` LIKE 'description'");
            $stmt_check->execute();
            if ($stmt_check->rowCount() > 0) {
                $pdo->exec("ALTER TABLE `{$table_name}` DROP COLUMN `description`");
            }
            
            // manufacturer_idカラムが存在しない場合は追加
            $stmt_check = $pdo->prepare("SHOW COLUMNS FROM `{$table_name}` LIKE 'manufacturer_id'");
            $stmt_check->execute();
            if ($stmt_check->rowCount() === 0) {
                $pdo->exec("ALTER TABLE `{$table_name}` ADD COLUMN `manufacturer_id` VARCHAR(255) NOT NULL AFTER `id`");
                // 既存データにmanufacturer_idを設定
                $pdo->exec("UPDATE `{$table_name}` SET `manufacturer_id` = '{$manufacturer_id}' WHERE `manufacturer_id` IS NULL OR `manufacturer_id` = ''");
            }
            
            // idカラムが存在しない場合は追加
            $stmt_check_id = $pdo->prepare("SHOW COLUMNS FROM `{$table_name}` LIKE 'id'");
            $stmt_check_id->execute();
            if ($stmt_check_id->rowCount() === 0) {
                $pdo->exec("ALTER TABLE `{$table_name}` ADD COLUMN `id` VARCHAR(255) NOT NULL FIRST");
                // 既存データに対してidを生成（tag_{manufacturer_id}_{番号}形式）
                generateIdsForExistingTags($pdo, $table_name, $manufacturer_id);
                // 主キーを変更（idを主キーに）
                $pdo->exec("ALTER TABLE `{$table_name}` DROP PRIMARY KEY");
                $pdo->exec("ALTER TABLE `{$table_name}` ADD PRIMARY KEY (`id`)");
            }
            
            // nameカラムが存在しない場合は追加（tagNameやtag_nameから移行する可能性がある）
            $stmt_check = $pdo->prepare("SHOW COLUMNS FROM `{$table_name}` LIKE 'name'");
            $stmt_check->execute();
            if ($stmt_check->rowCount() === 0) {
                // tagNameカラムが存在する場合はnameにリネーム
                $stmt_check_tagName = $pdo->prepare("SHOW COLUMNS FROM `{$table_name}` LIKE 'tagName'");
                $stmt_check_tagName->execute();
                if ($stmt_check_tagName->rowCount() > 0) {
                    $pdo->exec("ALTER TABLE `{$table_name}` CHANGE COLUMN `tagName` `name` VARCHAR(255) NOT NULL");
                } else {
                    // tagNameも存在しない場合はnameカラムを追加
                    $pdo->exec("ALTER TABLE `{$table_name}` ADD COLUMN `name` VARCHAR(255) NOT NULL AFTER `manufacturer_id`");
                }
            }
            
            // カラムの順序を調整（id, manufacturer_id, nameの順序）
            // 注意: MySQLではカラムの順序を直接変更できないため、必要に応じてテーブルを再作成
            // ただし、既存データがある場合は慎重に処理する必要があるため、ここでは順序の変更は行わない
        } catch (Exception $e) {
            error_log("Failed to migrate tags table {$table_name}: " . $e->getMessage());
        }
    }
    
    return $table_name;
}

/**
 * メーカーごとのブランドテーブル（brands_{manufacturer_id}）が存在するか確認し、存在しない場合は作成
 * スキーマ: id, manufacturer_id, name（tagsと同じ）
 */
function ensureBrandsTable(&$pdo, $manufacturer_id) {
    $table_name = "brands_{$manufacturer_id}";
    
    // テーブルが存在するか確認（schema_utils.phpのtableExists関数を使用）
    $table_existed = tableExists($pdo, $table_name);
    
    if (!$table_existed) {
        // テーブルが存在しない場合は作成（tagsと同じスキーマ: id, manufacturer_id, name）
        $create_table_sql = "
            CREATE TABLE `{$table_name}` (
                `id` VARCHAR(255) NOT NULL,
                `manufacturer_id` VARCHAR(255) NOT NULL,
                `name` VARCHAR(255) NOT NULL,
                PRIMARY KEY (`id`),
                INDEX `idx_manufacturer` (`manufacturer_id`),
                UNIQUE KEY `unique_name` (`manufacturer_id`, `name`)
            ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci
        ";
        
        $pdo->exec($create_table_sql);
    } else {
        // 既存テーブルの場合、idカラムが存在しない場合は追加
        try {
            // idカラムが存在しない場合は追加
            $stmt_check = $pdo->prepare("SHOW COLUMNS FROM `{$table_name}` LIKE 'id'");
            $stmt_check->execute();
            if ($stmt_check->rowCount() === 0) {
                $pdo->exec("ALTER TABLE `{$table_name}` ADD COLUMN `id` VARCHAR(255) NOT NULL FIRST");
                // 既存データに対してidを生成（brand_{manufacturer_id}_{番号}形式）
                generateIdsForExistingBrands($pdo, $table_name, $manufacturer_id);
                // 主キーを変更（idを主キーに）
                $pdo->exec("ALTER TABLE `{$table_name}` DROP PRIMARY KEY");
                $pdo->exec("ALTER TABLE `{$table_name}` ADD PRIMARY KEY (`id`)");
            }
            
            // manufacturer_idカラムが存在しない場合は追加
            $stmt_check = $pdo->prepare("SHOW COLUMNS FROM `{$table_name}` LIKE 'manufacturer_id'");
            $stmt_check->execute();
            if ($stmt_check->rowCount() === 0) {
                $pdo->exec("ALTER TABLE `{$table_name}` ADD COLUMN `manufacturer_id` VARCHAR(255) NOT NULL AFTER `id`");
                // 既存データにmanufacturer_idを設定
                $pdo->exec("UPDATE `{$table_name}` SET `manufacturer_id` = '{$manufacturer_id}' WHERE `manufacturer_id` IS NULL OR `manufacturer_id` = ''");
            }
            
            // nameカラムが存在しない場合は追加（codeやbrandNameから移行する可能性がある）
            $stmt_check = $pdo->prepare("SHOW COLUMNS FROM `{$table_name}` LIKE 'name'");
            $stmt_check->execute();
            if ($stmt_check->rowCount() === 0) {
                // codeカラムが存在する場合はnameにリネーム
                $stmt_check_code = $pdo->prepare("SHOW COLUMNS FROM `{$table_name}` LIKE 'code'");
                $stmt_check_code->execute();
                if ($stmt_check_code->rowCount() > 0) {
                    $pdo->exec("ALTER TABLE `{$table_name}` CHANGE COLUMN `code` `name` VARCHAR(255) NOT NULL");
                } else {
                    // brandNameカラムが存在する場合はnameにリネーム
                    $stmt_check_brandName = $pdo->prepare("SHOW COLUMNS FROM `{$table_name}` LIKE 'brandName'");
                    $stmt_check_brandName->execute();
                    if ($stmt_check_brandName->rowCount() > 0) {
                        $pdo->exec("ALTER TABLE `{$table_name}` CHANGE COLUMN `brandName` `name` VARCHAR(255) NOT NULL");
                    } else {
                        // nameカラムを追加
                        $pdo->exec("ALTER TABLE `{$table_name}` ADD COLUMN `name` VARCHAR(255) NOT NULL AFTER `manufacturer_id`");
                    }
                }
            }
        } catch (Exception $e) {
            error_log("Failed to migrate brands table {$table_name}: " . $e->getMessage());
        }
    }
    
    return $table_name;
}

/**
 * 既存のbrandsテーブルのデータに対してidを生成（brand_{manufacturer_id}_{番号}形式）
 */
function generateIdsForExistingBrands(&$pdo, $table_name, $manufacturer_id) {
    try {
        // id_formatsテーブルからprefixとpaddingを取得
        $stmt_format = $pdo->prepare("SELECT prefix, padding FROM id_formats WHERE table_name = 'brands'");
        $stmt_format->execute();
        $format = $stmt_format->fetch();
        
        $prefix = $format ? $format['prefix'] : 'brand_';
        $padding = $format ? intval($format['padding']) : 4;
        
        // manufacturerPrefixを生成（例: brand_manu_0001_）
        $manufacturer_prefix = "{$prefix}{$manufacturer_id}_";
        $num_padding = max(1, $padding - strlen($manufacturer_prefix));
        
        // 既存データを取得
        $stmt = $pdo->query("SELECT * FROM `{$table_name}` WHERE `id` IS NULL OR `id` = ''");
        $rows = $stmt->fetchAll(PDO::FETCH_ASSOC);
        
        // 既存のidから最大番号を取得
        $stmt_max = $pdo->query("SELECT MAX(CAST(SUBSTRING(`id`, " . (strlen($manufacturer_prefix) + 1) . ") AS UNSIGNED)) as max_num FROM `{$table_name}` WHERE `id` LIKE '{$manufacturer_prefix}%'");
        $max_result = $stmt_max->fetch();
        $max_num = $max_result && $max_result['max_num'] ? intval($max_result['max_num']) : 0;
        
        // 各データに対してidを生成
        foreach ($rows as $index => $row) {
            $max_num++;
            $new_id = $manufacturer_prefix . str_pad(strval($max_num), $num_padding, '0', STR_PAD_LEFT);
            
            // idを更新
            $stmt_update = $pdo->prepare("UPDATE `{$table_name}` SET `id` = ? WHERE `id` IS NULL OR `id` = '' LIMIT 1");
            $stmt_update->execute([$new_id]);
        }
    } catch (Exception $e) {
        error_log("Failed to generate IDs for existing brands in {$table_name}: " . $e->getMessage());
    }
}

/**
 * 既存のtagsテーブルのデータに対してidを生成（tag_{manufacturer_id}_{番号}形式）
 */
function generateIdsForExistingTags(&$pdo, $table_name, $manufacturer_id) {
    try {
        // id_formatsテーブルからprefixとpaddingを取得
        $stmt_format = $pdo->prepare("SELECT prefix, padding FROM id_formats WHERE table_name = 'tags'");
        $stmt_format->execute();
        $format = $stmt_format->fetch();
        
        $prefix = $format ? $format['prefix'] : 'tag_';
        $padding = $format ? intval($format['padding']) : 4;
        
        // manufacturerPrefixを生成（例: tag_manu_0001_）
        $manufacturer_prefix = "{$prefix}{$manufacturer_id}_";
        $num_padding = max(1, $padding - strlen($manufacturer_prefix));
        
        // 既存データを取得
        $stmt = $pdo->query("SELECT * FROM `{$table_name}` WHERE `id` IS NULL OR `id` = ''");
        $rows = $stmt->fetchAll(PDO::FETCH_ASSOC);
        
        // 既存のidから最大番号を取得
        $stmt_max = $pdo->query("SELECT MAX(CAST(SUBSTRING(`id`, " . (strlen($manufacturer_prefix) + 1) . ") AS UNSIGNED)) as max_num FROM `{$table_name}` WHERE `id` LIKE '{$manufacturer_prefix}%'");
        $max_result = $stmt_max->fetch();
        $max_num = $max_result && $max_result['max_num'] ? intval($max_result['max_num']) : 0;
        
        // 各データに対してidを生成
        foreach ($rows as $index => $row) {
            $max_num++;
            $new_id = $manufacturer_prefix . str_pad(strval($max_num), $num_padding, '0', STR_PAD_LEFT);
            
            // idを更新
            $stmt_update = $pdo->prepare("UPDATE `{$table_name}` SET `id` = ? WHERE `id` IS NULL OR `id` = '' LIMIT 1");
            $stmt_update->execute([$new_id]);
        }
    } catch (Exception $e) {
        error_log("Failed to generate IDs for existing tags in {$table_name}: " . $e->getMessage());
    }
}

/**
 * メーカー依存テーブル用のIDを生成（{prefix}_{manufacturer_id}_{番号}形式）
 * @param string $table_name テーブル名（例: 'brands', 'tags'）
 * @param PDO $pdo データベース接続
 * @param string $manufacturer_id メーカーID
 * @return string 生成されたID
 */
function generateManufacturerDependentId(&$pdo, $table_name, $manufacturer_id) {
    try {
        // id_formatsテーブルからprefixとpaddingを取得
        $stmt_format = $pdo->prepare("SELECT prefix, padding FROM id_formats WHERE table_name = ?");
        $stmt_format->execute([$table_name]);
        $format = $stmt_format->fetch();
        
        $prefix = $format ? $format['prefix'] : substr($table_name, 0, 4) . '_';
        $padding = $format ? intval($format['padding']) : 4;
        
        // manufacturerPrefixを生成（例: brand_manu_0001_ または tag_manu_0001_）
        $manufacturer_prefix = "{$prefix}{$manufacturer_id}_";
        $num_padding = max(1, $padding - strlen($manufacturer_prefix));
        
        // テーブル名を取得（メーカー依存テーブルの場合）
        $manufacturer_table_name = "{$table_name}_{$manufacturer_id}";
        
        // 既存のidから最大番号を取得
        $stmt_max = $pdo->prepare("SELECT MAX(CAST(SUBSTRING(`id`, " . (strlen($manufacturer_prefix) + 1) . ") AS UNSIGNED)) as max_num FROM `{$manufacturer_table_name}` WHERE `id` LIKE ?");
        $stmt_max->execute([$manufacturer_prefix . '%']);
        $max_result = $stmt_max->fetch();
        $max_num = $max_result && $max_result['max_num'] ? intval($max_result['max_num']) : 0;
        
        // 新しい番号を生成
        $new_num = $max_num + 1;
        $new_id = $manufacturer_prefix . str_pad(strval($new_num), $num_padding, '0', STR_PAD_LEFT);
        
        return $new_id;
    } catch (Exception $e) {
        error_log("Failed to generate ID for {$table_name}_{$manufacturer_id}: " . $e->getMessage());
        // フォールバック: タイムスタンプベースのID
        return "{$prefix}{$manufacturer_id}_" . time();
    }
}

/**
 * 数値を正規化（カンマ除去、小数点処理）
 * 注意: validation_utils.phpのnormalizeNumericValue関数を使用
 * validation_utils.phpが先に読み込まれるため、この関数は定義されません
 */

/**
 * カラー名からコロン以降を抽出（例: "1155:light blue" → "light blue"）
 */
function extractColorName($color_name) {
    if (empty($color_name)) {
        return '';
    }
    
    // コロンで分割
    $parts = explode(':', $color_name, 2);
    
    // コロン以降がある場合はそれを返す、ない場合は元の値を返す
    return count($parts) > 1 ? trim($parts[1]) : trim($parts[0]);
}

/**
 * 日付形式を正規化（Y-m-d形式に変換）
 * 年がない場合は現在の年を補完
 */
function normalizeDate($date_string) {
    if (empty($date_string)) {
        return null;
    }
    
    // 文字列に変換してトリム
    $date_string = trim((string)$date_string);
    
    // 空の場合はnullを返す
    if ($date_string === '') {
        return null;
    }
    
    // スラッシュ区切りの日付を処理（例: "2025/12/20" または "02/10"）
    if (preg_match('/^(\d{1,2})\/(\d{1,2})(?:\/(\d{2,4}))?$/', $date_string, $matches)) {
        $month = intval($matches[1]);
        $day = intval($matches[2]);
        $year = isset($matches[3]) ? intval($matches[3]) : null;
        
        // 年がない場合は現在の年を補完
        if ($year === null) {
            $year = intval(date('Y'));
        } else if ($year < 100) {
            // 2桁の年の場合は2000年台と仮定
            $year = 2000 + $year;
        }
        
        // 日付の妥当性をチェック
        if (checkdate($month, $day, $year)) {
            return sprintf('%04d-%02d-%02d', $year, $month, $day);
        }
    }
    
    // ハイフン区切りの日付を処理（例: "2025-12-20"）
    if (preg_match('/^(\d{4})-(\d{1,2})-(\d{1,2})$/', $date_string, $matches)) {
        $year = intval($matches[1]);
        $month = intval($matches[2]);
        $day = intval($matches[3]);
        
        if (checkdate($month, $day, $year)) {
            return sprintf('%04d-%02d-%02d', $year, $month, $day);
        }
    }
    
    // strtotimeで解析を試みる
    $timestamp = strtotime($date_string);
    if ($timestamp !== false) {
        $parsed_date = date('Y-m-d', $timestamp);
        // 1970-01-01の場合は無効とみなす
        if ($parsed_date !== '1970-01-01') {
            return $parsed_date;
        }
    }
    
    // 解析できない場合はnullを返す
    return null;
}

/**
 * サイズ名からサイズコードを生成（サイズコードがない場合）
 */
function generateSizeCode($size_name) {
    if (empty($size_name)) {
        return '';
    }
    
    // サイズ名をそのまま使用（必要に応じて正規化）
    $size_code = trim((string)$size_name);
    
    // サイズ名をそのままサイズコードとして使用
    return $size_code;
}

/**
 * CSVファイルをパースする（サーバー側で直接パース）
 * ブラウザの干渉を避けるため、ファイルを直接受け取ってパース
 * 先頭0を保持するため、コード系カラムを文字列として扱う
 * @param string $file_path CSVファイルのパス
 * @param string $encoding エンコーディング
 * @param array|null $mapping マッピング情報（オプション、コード系カラムの判定に使用）
 */
function parseCsvFile($file_path, $encoding = 'UTF-8', $mapping = null) {
    $data = [];
    $headers = [];
    $header_found = false;
    
    // ファイルを開く
    $handle = fopen($file_path, 'r');
    if ($handle === false) {
        throw new Exception("CSVファイルを開けませんでした。");
    }
    
    // BOMをスキップ
    $bom = fread($handle, 3);
    if ($bom !== "\xEF\xBB\xBF") {
        rewind($handle);
    }
    
    // エンコーディング変換が必要な場合
    if ($encoding !== 'UTF-8') {
        // 一時ファイルに変換してから読み込む
        $temp_file = tempnam(sys_get_temp_dir(), 'csv_');
        $temp_handle = fopen($temp_file, 'w');
        $content = file_get_contents($file_path);
        $converted = mb_convert_encoding($content, 'UTF-8', $encoding);
        file_put_contents($temp_file, $converted);
        fclose($handle);
        fclose($temp_handle);
        $handle = fopen($temp_file, 'r');
    }
    
    $row_index = 0;
    $code_columns = ['code', 'sizeCode', 'colorCode', 'size_code', 'color_code', 'product_code', 'productCode', 'jan_code'];
    
    // マッピング情報からコード系のCSV列名を特定
    $csv_code_columns = [];
    if ($mapping) {
        foreach ($mapping as $field => $csv_column) {
            if (in_array($field, $code_columns) && !empty($csv_column)) {
                $csv_code_columns[] = $csv_column;
            }
        }
    }
    
    while (($row = fgetcsv($handle, 0, ',', '"', '"')) !== false) {
        // 空行をスキップ
        if (empty(array_filter($row, function($v) { return trim($v) !== ''; }))) {
            continue;
        }
        
        if (!$header_found) {
            // ヘッダー行
            $headers = array_map('trim', $row);
            $header_found = true;
            continue;
        }
        
        // データ行
        if (count($row) !== count($headers)) {
            // 列数が一致しない場合は警告を出してスキップ
            continue;
        }
        
        $row_data = [];
        foreach ($headers as $index => $header) {
            $value = isset($row[$index]) ? $row[$index] : '';
            
            if ($value === '' || $value === null) {
                $row_data[$header] = null;
            } elseif (in_array($header, $code_columns) || in_array($header, $csv_code_columns)) {
                // コード系のカラムは常に文字列として扱う（先頭0を保持）
                // fgetcsvは文字列として返すが、Excelで数値として保存されている場合は先頭0が失われている可能性がある
                // 確実に文字列として扱い、数値への変換を避ける
                $value_str = trim((string)$value);
                // 数値として解釈されている場合でも、文字列として扱う
                // 注意: CSVファイル自体がExcelで数値として保存されている場合（例：001が1として保存）、先頭0は復元できない
                // そのため、CSVファイルを保存する際は、該当列を「文字列」として設定する必要がある
                $row_data[$header] = $value_str;
            } else {
                // 数値かどうかを判定
                $value_str = trim((string)$value);
                if ($value_str === '') {
                    $row_data[$header] = null;
                } elseif (strtolower($value_str) === 'true') {
                    $row_data[$header] = true;
                } elseif (strtolower($value_str) === 'false') {
                    $row_data[$header] = false;
                } else {
                    // HTMLエンティティをデコード
                    $value_str = html_entity_decode($value_str, ENT_QUOTES | ENT_HTML5, 'UTF-8');
                    // カンマを除去してから数値判定
                    $numeric_str = str_replace(',', '', $value_str);
                    if (is_numeric($numeric_str) && is_finite(floatval($numeric_str))) {
                        // 数値として扱う（整数フィールドの場合は整数に変換）
                        $numeric_value = floatval($numeric_str);
                        // 小数点以下がない場合は整数として扱う
                        if ($numeric_value == intval($numeric_value)) {
                            $row_data[$header] = intval($numeric_value);
                        } else {
                            $row_data[$header] = $numeric_value;
                        }
                    } else {
                        $row_data[$header] = $value_str;
                    }
                }
            }
        }
        
        $data[] = $row_data;
        $row_index++;
    }
    
    fclose($handle);
    
    return $data;
}

// --- Main Logic ---

if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
    http_response_code(405);
    echo json_encode(['error' => 'Only POST method is accepted.']);
    exit();
}

// FormDataでファイルが送信された場合の処理
$csv_data = null;
$mapping = null;
$manufacturer_id = null;
$debug_mode = false;
$skip_validation_errors = false;
$skip_error_rows = true;

if (isset($_FILES['csv_file']) && $_FILES['csv_file']['error'] === UPLOAD_ERR_OK) {
    // FormDataでファイルが送信された場合
    $file_path = $_FILES['csv_file']['tmp_name'];
    $encoding = $_POST['encoding'] ?? 'UTF-8';
    
    try {
        // マッピング情報を取得（コード系カラムの判定に使用）
        $mapping_for_parse = json_decode($_POST['mapping'] ?? '{}', true);
        $csv_data = parseCsvFile($file_path, $encoding, $mapping_for_parse);
    } catch (Exception $e) {
        http_response_code(400);
        echo json_encode(['success' => false, 'message' => 'CSVファイルのパースに失敗しました: ' . $e->getMessage()]);
        exit();
    }
    
    // その他のパラメータをPOSTから取得
    $mapping = json_decode($_POST['mapping'] ?? '{}', true);
    $product_settings = json_decode($_POST['productSettings'] ?? '{}', true);
    $manufacturer_id = $_POST['manufacturerId'] ?? null;
    $debug_mode = isset($_POST['debug']) && $_POST['debug'] === 'true';
    $skip_validation_errors = isset($_POST['skipValidationErrors']) && $_POST['skipValidationErrors'] === 'true';
    $skip_error_rows = !isset($_POST['skipErrorRows']) || $_POST['skipErrorRows'] === 'true';
} else {
    // 従来のJSON形式でのリクエスト（後方互換性のため）
    $json_data = file_get_contents('php://input');
    $request = json_decode($json_data, true);
    
    if (json_last_error() !== JSON_ERROR_NONE || !isset($request['data']) || !isset($request['mapping'])) {
        http_response_code(400);
        echo json_encode(['success' => false, 'message' => 'Invalid JSON payload or missing CSV file.']);
        exit();
    }
    
    $csv_data = $request['data'];
    $mapping = $request['mapping'];
    $manufacturer_id = $request['manufacturerId'] ?? null;
    $debug_mode = $request['debug'] ?? false;
    $skip_validation_errors = $request['skipValidationErrors'] ?? false;
    $skip_error_rows = $request['skipErrorRows'] ?? true;
}

$tool_name = 'data-io'; // データ入出力ツールの固定ツール名

// アプリケーションモードを取得（CSV書き込みモードの判定用）
$app_mode = $_POST['appMode'] ?? 'live';

// 詳細なログ出力用の関数
$debug_log = [];
function logDebug($message, $data = null, $level = 'info') {
    global $debug_log;
    $entry = [
        'timestamp' => date('Y-m-d H:i:s.u'),
        'level' => $level,
        'message' => $message
    ];
    if ($data !== null) {
        $entry['data'] = is_array($data) || is_object($data) ? json_encode($data, JSON_UNESCAPED_UNICODE | JSON_PARTIAL_OUTPUT_ON_ERROR) : $data;
    }
    $debug_log[] = $entry;
    
    // エラーレベルの場合はerror_logにも出力
    if ($level === 'error' || $level === 'warning') {
        error_log("[import-stock.php] [{$level}] {$message}" . ($data !== null ? " | Data: " . json_encode($data, JSON_UNESCAPED_UNICODE) : ""));
    }
}

if (!$manufacturer_id) {
    logDebug('Manufacturer ID is missing', [
        'POST_data' => $_POST,
        'FILES_data' => isset($_FILES) ? array_keys($_FILES) : []
    ], 'error');
    http_response_code(400);
    echo json_encode([
        'success' => false, 
        'message' => 'Manufacturer ID is required.',
        'debug' => [
            'manufacturer_id' => $manufacturer_id,
            'POST_keys' => array_keys($_POST ?? []),
            'has_csv_file' => isset($_FILES['csv_file'])
        ]
    ], JSON_UNESCAPED_UNICODE);
    exit();
}

// CSV書き込みモードの場合は、データベースへの書き込みをスキップしてCSVファイルに直接書き込む
// 注意: CSV書き込みモードでは、データベースへの書き込みは行わず、CSVファイルに直接書き込む
// この処理は、通常のインポート処理の後に実行される（データベースへの書き込みをスキップする）

logDebug('Import request received', [
    'manufacturer_id' => $manufacturer_id,
    'total_rows' => count($csv_data),
    'mapping_fields' => array_keys($mapping),
    'debug_mode' => $debug_mode
]);

// Access control check: verify that data-io tool has INSERT/UPDATE permission for manufacturer-dependent tables
// メーカー依存テーブルのベース名リスト
// 注意: colors, sizes, incoming_stockは削除（stockテーブルから直接取得）
// 注意: products_masterは削除（stockテーブルに統合）
$manufacturer_dependent_tables = ['stock', 'product_details'];

foreach ($manufacturer_dependent_tables as $base_table_name) {
    // ベーステーブル名でアクセス制御をチェック
    $accessControlQuery = "SELECT allowed_operations, write_fields FROM tool_dependencies WHERE tool_name = :tool_name AND table_name = :table_name";
    $accessControlStmt = $pdo->prepare($accessControlQuery);
    $accessControlStmt->execute(['tool_name' => $tool_name, 'table_name' => $base_table_name]);
    $accessControl = $accessControlStmt->fetch(PDO::FETCH_ASSOC);
    
    if ($accessControl) {
        // Get allowed_operations, defaulting to '*' if NULL or empty (backward compatibility)
        $allowedOpsStr = $accessControl['allowed_operations'] ?? '*';
        if ($allowedOpsStr === '' || $allowedOpsStr === null) {
            $allowedOpsStr = '*'; // デフォルトですべて許可
        }
        
        // Parse allowed operations
        $allowedOps = $allowedOpsStr === '*' 
            ? ['INSERT', 'UPDATE', 'DELETE'] 
            : array_map('trim', explode(',', strtoupper($allowedOpsStr)));
        
        // Check if INSERT and UPDATE operations are allowed
        if (!in_array('INSERT', $allowedOps) || !in_array('UPDATE', $allowedOps)) {
            http_response_code(403); // Forbidden
            echo json_encode([
                'success' => false,
                'message' => "データ入出力ツールは、テーブル '{$base_table_name}' に対してINSERT/UPDATE操作を実行する権限がありません。",
                'debug' => [
                    'tool_name' => $tool_name,
                    'table_name' => $base_table_name,
                    'allowed_operations' => $allowedOps,
                    'access_control_found' => true
                ]
            ]);
            exit();
        }
        
        error_log("[import-stock.php] Access control check passed: tool_name={$tool_name}, table_name={$base_table_name}, INSERT/UPDATE allowed");
    } else {
        // If no access control is defined, allow all operations (backward compatibility)
        error_log("[import-stock.php] No access control found for tool '{$tool_name}' on table '{$base_table_name}', allowing INSERT/UPDATE (backward compatibility)");
    }
}

// データ検証：validation_utils.phpを使用
logDebug('Starting data validation');
$required_fields = ['product_code', 'color_code', 'size_code']; // stock_quantityは任意（未入力も有効）
$validation_rules = getStockValidationRules();
$validation_result = validateCsvData($csv_data, $mapping, $required_fields, $validation_rules);

logDebug('Validation completed', [
    'valid' => $validation_result['valid'],
    'error_count' => count($validation_result['errors']),
    'warning_count' => count($validation_result['warnings']),
    'statistics' => $validation_result['statistics']
]);

// 検証エラーがある場合の処理
$error_row_indices = [];
if (!$validation_result['valid']) {
    if ($skip_validation_errors) {
        // 検証エラーがあっても続行する場合
        logDebug('Validation errors detected but continuing import', [
            'error_count' => count($validation_result['errors']),
            'invalid_rows' => $validation_result['statistics']['invalid_rows'],
            'skip_validation_errors' => true
        ], 'warning');
        
        // エラー行のインデックスを記録（行番号からCSVのインデックスに変換）
        if (isset($validation_result['row_errors']) && is_array($validation_result['row_errors'])) {
            foreach ($validation_result['row_errors'] as $row_num => $errors) {
                // 行番号はCSVの行番号（ヘッダー行を考慮して+2されているので、-2してインデックスに変換）
                $error_row_indices[] = $row_num - 2;
            }
        }
    } else {
        // 従来通りエラーを返す
        http_response_code(400);
        echo json_encode([
            'success' => false,
            'message' => 'データ検証に失敗しました',
            'validation' => [
                'errors' => $validation_result['errors'],
                'warnings' => $validation_result['warnings'],
                'statistics' => $validation_result['statistics'],
                'row_errors' => $validation_result['row_errors']
            ],
            'debug_log' => $debug_mode ? $debug_log : null
        ], JSON_UNESCAPED_UNICODE);
        exit();
    }
}

// 警告がある場合はログに記録
if (!empty($validation_result['warnings'])) {
    foreach ($validation_result['warnings'] as $warning) {
        logDebug($warning, null, 'warning');
    }
}

$summary = [
    'totalRows' => count($csv_data),
    'updatedStock' => 0,
    'newItems' => 0,
    'skippedUnchanged' => 0,  // 変更がなくスキップされたレコード数
    'newProducts' => 0,
    'newColors' => 0,
    'newSizes' => 0,
    'newIncomingStock' => 0,  // 新規登録された入荷予定数
    'updatedIncomingStock' => 0,  // 更新された入荷予定数
    'errors' => [],
    'errorSummary' => []  // エラーを集約（メッセージ => 件数）
];

// CSV書き込みモード用のデータ収集配列
$csv_stock_data = []; // stockテーブルのデータ
$csv_product_details_data = []; // product_detailsテーブルのデータ
$csv_product_details_map = []; // product_code => product_details のマップ（重複を防ぐ）

try {
    // CSV書き込みモードの場合は、データベースへの書き込みをスキップ
    if ($app_mode !== 'csv-writable') {
    $pdo->beginTransaction();
    }
    
    // メーカーごとの在庫テーブルを確認・作成（CSV書き込みモードではスキップ）
    $stock_table = null;
    $stock_table_existed = false;
    if ($app_mode !== 'csv-writable') {
    $stock_table = ensureStockTable($pdo, $manufacturer_id);
    $stock_table_existed = tableExists($pdo, $stock_table);
    } else {
        // CSV書き込みモードでは、テーブル名のみを生成（ファイル名の決定に使用）
        $stock_table = "{$manufacturer_id}_stock";
    }
    
    // stockテーブルのcreated_atとupdated_atカラムの存在を確認（CSV書き込みモードではスキップ）
    $hasStockCreatedAt = false;
    $hasStockUpdatedAt = false;
    if ($app_mode !== 'csv-writable' && $stock_table_existed) {
        $stmt_col_check = $pdo->prepare("SHOW COLUMNS FROM `{$stock_table}` LIKE 'created_at'");
        $stmt_col_check->execute();
        $hasStockCreatedAt = $stmt_col_check->rowCount() > 0;
        
        $stmt_col_check = $pdo->prepare("SHOW COLUMNS FROM `{$stock_table}` LIKE 'updated_at'");
        $stmt_col_check->execute();
        $hasStockUpdatedAt = $stmt_col_check->rowCount() > 0;
    } else {
        // 新規作成されたテーブルには必ずcreated_atとupdated_atがある
        $hasStockCreatedAt = true;
        $hasStockUpdatedAt = true;
    }
    
    // 注意: incoming_stockテーブルは削除（入荷情報はstockテーブルに直接保存）
    
    // メーカーごとの商品関連テーブルを確認・作成（商品データ管理で必要）
    // 注意: product_colors, product_prices, skusは非推奨（stockテーブルから取得）
    // 注意: product_tags_manu_xxxxは削除（product_details_manu_xxxxのtagsフィールドで管理）
    // CSV書き込みモードでは、データベースへの書き込みをスキップ
    if ($app_mode !== 'csv-writable') {
    ensureProductSizesTable($pdo, $manufacturer_id);
    ensureProductColorSizesTable($pdo, $manufacturer_id);
    ensureTagsTable($pdo, $manufacturer_id); // メーカー依存のタグマスターテーブル
    ensureBrandsTable($pdo, $manufacturer_id); // メーカー依存のブランドマスターテーブル
    }
    
    // CSV書き込みモードの場合、既存のCSVファイルを読み込む
    if ($app_mode === 'csv-writable') {
        // getCsvPath関数を定義（save-csv.phpからコピー）
        if (!function_exists('getCsvPath')) {
            function getCsvPath($tableName, $manufacturerId = null) {
                // colors, sizesはstockテーブルから取得されるため、直接保存しない
                if ($tableName === 'colors' || $tableName === 'sizes') {
                    return null;
                }
                
                // テーブル名からベーステーブル名とメーカーIDを抽出
                $parsed = parseManufacturerTableNameForCsv($tableName);
                if ($parsed['manufacturerId'] !== null) {
                    $tableName = $parsed['baseTableName'];
                    if ($manufacturerId === null) {
                        $manufacturerId = $parsed['manufacturerId'];
                    }
                }
                
                // メーカー依存テーブルのリスト
                $manufacturerDependentTables = [
                    'products_master', 'product_details', 'product_tags',
                    'stock', 'importer_mappings', 'tags'
                ];
                
                // メーカー依存テーブルの場合
                if (in_array($tableName, $manufacturerDependentTables)) {
                    if ($manufacturerId) {
                        $cleanManufacturerId = $manufacturerId;
                        if (strpos($cleanManufacturerId, 'manu_') === 0) {
                            $cleanManufacturerId = substr($cleanManufacturerId, 5);
                        }
                        $fileName = $tableName;
                        if ($tableName === 'product_details') {
                            $fileName = 'details';
                        } else if ($tableName === 'stock') {
                            $fileName = 'stock';
                        }
                        return "templates/manufacturers/manu_{$cleanManufacturerId}/manu_{$cleanManufacturerId}_{$fileName}.csv";
                    } else {
                        return null;
                    }
                }
                
                // 共通テーブル
                $commonTables = ['manufacturers', 'categories', 'prefectures', 'brands'];
                if (in_array($tableName, $commonTables)) {
                    return "templates/common/{$tableName}.csv";
                }
                
                return "templates/{$tableName}.csv";
            }
            
            function parseManufacturerTableNameForCsv($tableName) {
                $manufacturerDependentTables = [
                    'products_master', 'product_details', 'product_tags',
                    'stock', 'importer_mappings', 'tags'
                ];
                
                if (strpos($tableName, 'manu_') === 0) {
                    foreach ($manufacturerDependentTables as $baseTableName) {
                        $fileName = $baseTableName;
                        if ($baseTableName === 'product_details') {
                            $fileName = 'details';
                        } else if ($baseTableName === 'stock') {
                            $fileName = 'stock';
                        } else if ($baseTableName === 'tags') {
                            $fileName = 'tags';
                        }
                        $suffix = '_' . $fileName;
                        if (substr($tableName, -strlen($suffix)) === $suffix) {
                            $manufacturerId = substr($tableName, 0, strlen($tableName) - strlen($suffix));
                            return ['baseTableName' => $baseTableName, 'manufacturerId' => $manufacturerId];
                        }
                    }
                }
                return ['baseTableName' => $tableName, 'manufacturerId' => null];
            }
        }
        
        // 既存のstock CSVファイルを読み込む
        $stock_csv_path = getCsvPath("manu_{$manufacturer_id}_stock", $manufacturer_id);
        if ($stock_csv_path && file_exists($stock_csv_path)) {
            try {
                $existing_stock_data = parseCsvFile($stock_csv_path, 'UTF-8');
                foreach ($existing_stock_data as $row) {
                    $csv_stock_data[] = $row;
                }
                logDebug('Loaded existing stock CSV', ['path' => $stock_csv_path, 'rows' => count($existing_stock_data)]);
            } catch (Exception $e) {
                logDebug('Failed to load existing stock CSV', ['path' => $stock_csv_path, 'error' => $e->getMessage()], 'warning');
            }
        }
        
        // 既存のproduct_details CSVファイルを読み込む
        $details_csv_path = getCsvPath("manu_{$manufacturer_id}_details", $manufacturer_id);
        if ($details_csv_path && file_exists($details_csv_path)) {
            try {
                $existing_details_data = parseCsvFile($details_csv_path, 'UTF-8');
                foreach ($existing_details_data as $row) {
                    $product_code_key = $row['product_code'] ?? '';
                    if ($product_code_key) {
                        $csv_product_details_map[$product_code_key] = $row;
                    }
                }
                logDebug('Loaded existing product_details CSV', ['path' => $details_csv_path, 'rows' => count($existing_details_data)]);
            } catch (Exception $e) {
                logDebug('Failed to load existing product_details CSV', ['path' => $details_csv_path, 'error' => $e->getMessage()], 'warning');
            }
        }
    }
    
    foreach ($csv_data as $index => $row) {
        // 検証エラーがある行をスキップ（skip_validation_errorsが有効な場合）
        if ($skip_validation_errors && !empty($error_row_indices) && in_array($index, $error_row_indices, true)) {
            logDebug("Skipping row with validation error", [
                'row' => $index + 2,
                'errors' => $validation_result['row_errors'][$index + 2] ?? []
            ], 'warning');
            $summary['errors'][] = "[行 " . ($index + 2) . "] 検証エラーのためスキップされました";
            continue;
        }
        
        try {
            // デバッグログ：行処理開始
            if ($debug_mode && $index < 5) { // 最初の5行のみ詳細ログ
                logDebug("Processing row " . ($index + 2), [
                    'row_data_sample' => array_slice($row, 0, 5, true) // 最初の5列のみ
                ]);
            }
            
            // --- 1. 必須フィールドの取得（テキストとして扱う：先頭の0を保持） ---
            // 品番、カラーコード、サイズコードは数字ではなくテキストとして認識
            // 先頭に0が複数つくものが多数あるため、文字列として扱う
            
            // マッピングされた列名を取得（存在確認済み）
            $product_code_column = $mapping['product_code'] ?? '';
            $product_code = !empty($product_code_column) ? trim((string)($row[$product_code_column] ?? '')) : '';
            if (!$product_code) {
                $error_msg = "Row " . ($index + 2) . ": Product code is missing (マッピング列: '{$product_code_column}').";
                logDebug($error_msg, ['row_index' => $index + 2, 'column' => $product_code_column, 'row_sample' => array_slice($row, 0, 3, true)], 'error');
                throw new Exception($error_msg);
            }
            
            $color_code_column = $mapping['color_code'] ?? '';
            $color_code_raw = $row[$color_code_column] ?? '';
            // コード系の値は確実に文字列として扱う（先頭0を保持）
            // 数値として解釈されている可能性があるため、文字列に変換してからtrim
            $color_code = !empty($color_code_column) ? trim((string)$color_code_raw) : '';
            // 000や00のようなコードも有効な値として扱う（空文字列やnullのみをエラーとする）
            if ($color_code === '' || $color_code === null) {
                throw new Exception("Row " . ($index + 2) . ": Color code is missing (マッピング列: '{$color_code_column}').");
            }
            
            $size_code_column = $mapping['size_code'] ?? '';
            $size_code_raw = $row[$size_code_column] ?? '';
            // コード系の値は確実に文字列として扱う（先頭0を保持）
            $size_code = !empty($size_code_column) ? trim((string)$size_code_raw) : '';
            // サイズコードがない場合はサイズ名から生成
            // 000や00のようなコードも有効な値として扱う（空文字列やnullのみをエラーとする）
            if ($size_code === '' || $size_code === null) {
                $size_name_column = $mapping['size_name'] ?? '';
                $size_name_temp = !empty($size_name_column) ? ($row[$size_name_column] ?? '') : '';
                $size_code = generateSizeCode($size_name_temp);
                if (!$size_code) {
                    throw new Exception("Row " . ($index + 2) . ": Size code is missing and cannot be generated from size name (マッピング列: '{$size_code_column}', サイズ名列: '{$size_name_column}').");
                }
            }
            
            // --- 2. オプションフィールドの取得と正規化 ---
            $product_name_column = $mapping['product_name'] ?? '';
            $product_name = !empty($product_name_column) ? ($row[$product_name_column] ?? '') : '';
            
            $color_name_column = $mapping['color_name'] ?? '';
            $color_name_raw = !empty($color_name_column) ? ($row[$color_name_column] ?? '') : '';
            // カラー名からコロン以降を抽出（例: "1155:light blue" → "light blue"）
            $color_name = extractColorName($color_name_raw);
            
            $size_name_column = $mapping['size_name'] ?? '';
            $size_name = !empty($size_name_column) ? ($row[$size_name_column] ?? '') : '';
            
            // 数値フィールドの正規化（カンマ除去、小数点処理）
            $stock_quantity_column = $mapping['stock_quantity'] ?? '';
            $stock_quantity_raw = !empty($stock_quantity_column) ? ($row[$stock_quantity_column] ?? 0) : 0;
            $stock_quantity = normalizeNumericValue($stock_quantity_raw) ?? 0;
            
            // 3件の入荷情報を取得
            $incoming_quantities = [];
            $incoming_dates = [];
            
            for ($i = 1; $i <= 3; $i++) {
                $qty_key = 'incoming_quantity_' . $i;
                $date_key = 'incoming_date_' . $i;
                
                $qty_column = $mapping[$qty_key] ?? '';
                $date_column = $mapping[$date_key] ?? '';
                
                $qty_raw = !empty($qty_column) ? ($row[$qty_column] ?? null) : null;
                $date_raw = !empty($date_column) ? ($row[$date_column] ?? null) : null;
                
                $incoming_quantities[$i] = normalizeNumericValue($qty_raw);
                $incoming_dates[$i] = normalizeDate($date_raw);
            }
            
            // 後方互換性のため、旧形式（incoming_quantity, incoming_date）もサポート
            if (empty($incoming_quantities[1]) && !empty($mapping['incoming_quantity'])) {
                $incoming_quantity_column = $mapping['incoming_quantity'];
                $incoming_quantities[1] = normalizeNumericValue($row[$incoming_quantity_column] ?? null);
            }
            if (empty($incoming_dates[1]) && !empty($mapping['incoming_date'])) {
                $incoming_date_column = $mapping['incoming_date'];
                $incoming_dates[1] = normalizeDate($row[$incoming_date_column] ?? null);
            }
            
            $list_price_column = $mapping['list_price'] ?? '';
            $list_price_raw = !empty($list_price_column) ? ($row[$list_price_column] ?? null) : null;
            $list_price = normalizeNumericValue($list_price_raw);
            
            $cost_price_column = $mapping['cost_price'] ?? '';
            $cost_price_raw = !empty($cost_price_column) ? ($row[$cost_price_column] ?? null) : null;
            $cost_price = normalizeNumericValue($cost_price_raw);
            
            $jan_code_column = $mapping['jan_code'] ?? '';
            $jan_code = !empty($jan_code_column) ? ($row[$jan_code_column] ?? null) : null;
            
            // --- 3. 関連データの自動登録（品番、カラー、サイズ） ---
            // 商品詳細テーブルに登録（新規登録されたかどうかを返す）
            // 注意: products_masterテーブルは削除（stockテーブルに統合）
            // スキーマ変更: product_id → product_code + manufacturer_id
            $details_table_name = "{$manufacturer_id}_details";
            $product_exists_before = false;
            $product_before = false;
            $product_after = false;
            
            if ($app_mode !== 'csv-writable') {
            $product_exists_before = tableExists($pdo, $details_table_name);
            
            if ($product_exists_before) {
                // product_codeカラムが存在するか確認
                $stmt_check = $pdo->prepare("SHOW COLUMNS FROM `{$details_table_name}` LIKE 'product_code'");
                $stmt_check->execute();
                $has_product_code = $stmt_check->rowCount() > 0;
                
                if ($has_product_code) {
                    $stmt_product_find = $pdo->prepare("SELECT product_code FROM `{$details_table_name}` WHERE manufacturer_id = ? AND product_code = ? LIMIT 1");
                    $stmt_product_find->execute([$manufacturer_id, $product_code]);
                    $product_before = $stmt_product_find->fetch();
                } else {
                    // 旧スキーマ（product_id）の場合
                    $product_id = "prod_{$manufacturer_id}_{$product_code}";
                    $stmt_product_find = $pdo->prepare("SELECT product_id FROM `{$details_table_name}` WHERE product_id = ? LIMIT 1");
                    $stmt_product_find->execute([$product_id]);
                    $product_before = $stmt_product_find->fetch();
                }
            }
            
            ensureProductDetails($pdo, $manufacturer_id, $product_code, $product_name, $stock_table);
            
            // 新規登録されたかどうかを確認
            $stmt_product_find_after = $pdo->prepare("SELECT product_code FROM `{$details_table_name}` WHERE manufacturer_id = ? AND product_code = ? LIMIT 1");
            $stmt_product_find_after->execute([$manufacturer_id, $product_code]);
            $product_after = $stmt_product_find_after->fetch();
            } else {
                // CSV書き込みモードでは、既存のproduct_detailsデータから検索
                if (isset($csv_product_details_map[$product_code])) {
                    $product_before = $csv_product_details_map[$product_code];
                }
                
                // product_detailsデータを収集（重複を防ぐ）
                if (!isset($csv_product_details_map[$product_code])) {
                    $product_details_id = "prod_{$manufacturer_id}_{$product_code}";
                    $csv_product_details_map[$product_code] = [
                        'id' => $product_details_id,
                        'manufacturer_id' => $manufacturer_id,
                        'product_code' => $product_code,
                        'productName' => $product_name,
                        'product_name' => $product_name,
                        'description' => null,
                        'images' => null,
                        'tags' => null,
                        'brand' => null,
                        'meta_title' => null,
                        'meta_description' => null,
                        'og_image_url' => null,
                        'og_title' => null,
                        'og_description' => null
                    ];
                    $product_after = true;
                }
            }
            
            if (!$product_before && $product_after) {
                $summary['newProducts']++;
            }
            
            // 注意: colors_manu_*とsizes_manu_*は削除（stockテーブルから直接取得）
            
            // 数値の検証（既に正規化済みのため、ここでは型チェックのみ）
            if (!is_numeric($stock_quantity)) {
                $stock_quantity = 0;
            }
            
            // --- 4. 既存レコードの検索（検索条件: manufacturer_id + product_code + color_code + size_code） ---
            // 同一製品の判定はメーカー、品番、カラー、サイズの4つで行う（SKUは参考程度）
            $existing = null;
            if ($app_mode !== 'csv-writable') {
            $stmt_find = $pdo->prepare("
                SELECT id, stock_product_name, color_name, size_name, quantity, 
                       incoming_quantity_1, incoming_date_1, incoming_quantity_2, incoming_date_2,
                       incoming_quantity_3, incoming_date_3, category_id, is_published, brand_id,
                       list_price, cost_price, jan_code
                FROM `{$stock_table}` 
                WHERE manufacturer_id = ? 
                  AND product_code = ? 
                  AND color_code = ? 
                  AND size_code = ?
                LIMIT 1
            ");
            $stmt_find->execute([$manufacturer_id, $product_code, $color_code, $size_code]);
            $existing = $stmt_find->fetch();
            } else {
                // CSV書き込みモードでは、既存のCSVデータから検索
                $item_id = 'stock_' . $manufacturer_id . '_' . $product_code . '_' . $color_code . '_' . $size_code;
                foreach ($csv_stock_data as $csv_row) {
                    if (($csv_row['id'] ?? '') === $item_id ||
                        (($csv_row['manufacturer_id'] ?? '') === $manufacturer_id &&
                         ($csv_row['product_code'] ?? '') === $product_code &&
                         ($csv_row['color_code'] ?? '') === $color_code &&
                         ($csv_row['size_code'] ?? '') === $size_code)) {
                        $existing = $csv_row;
                        break;
                    }
                }
            }
            
            // product_settingsから品番ごとの設定を取得
            $product_setting = $product_settings[$product_code] ?? [];
            $category_id = $product_setting['category_id'] ?? null;
            $is_published = isset($product_setting['is_published']) ? (int)$product_setting['is_published'] : null;
            $brand_id = $product_setting['brand_id'] ?? null;
            
            $now = date('Y-m-d H:i:s');
            
            if ($existing) {
                // 既存レコードの値と新しい値を比較して、変更があった場合のみ更新
                $hasChanges = false;
                
                // 各フィールドの変更をチェック
                if (($existing['stock_product_name'] ?? '') !== $product_name) $hasChanges = true;
                if (($existing['color_name'] ?? '') !== $color_name) $hasChanges = true;
                if (($existing['size_name'] ?? '') !== $size_name) $hasChanges = true;
                if ((int)($existing['quantity'] ?? 0) !== (int)$stock_quantity) $hasChanges = true;
                
                // incoming_quantity_1-3の比較（NULLを考慮）
                for ($i = 1; $i <= 3; $i++) {
                    $existing_qty = $existing["incoming_quantity_{$i}"] ?? null;
                    if ($existing_qty !== null) $existing_qty = (int)$existing_qty;
                    $incoming_qty = $incoming_quantities[$i] ?? null;
                    if ($incoming_qty !== null) $incoming_qty = (int)$incoming_qty;
                    if ($existing_qty !== $incoming_qty) $hasChanges = true;
                }
                
                // incoming_date_1-3の比較（NULLを考慮）
                for ($i = 1; $i <= 3; $i++) {
                    $existing_date = $existing["incoming_date_{$i}"] ?? null;
                    $incoming_date = $incoming_dates[$i] ?? null;
                    if ($existing_date && $incoming_date) {
                        $existing_date = date('Y-m-d', strtotime($existing_date));
                        $incoming_date_formatted = date('Y-m-d', strtotime($incoming_date));
                        if ($existing_date !== $incoming_date_formatted) $hasChanges = true;
                    } else if ($existing_date !== $incoming_date) {
                        $hasChanges = true;
                    }
                }
                
                // list_priceの比較（NULLを考慮）
                $existing_price = $existing['list_price'] ?? null;
                if ($existing_price !== null) $existing_price = (int)$existing_price;
                if ($list_price !== null) $list_price = (int)$list_price;
                if ($existing_price !== $list_price) $hasChanges = true;
                
                // cost_priceの比較（NULLを考慮）
                $existing_cost = $existing['cost_price'] ?? null;
                if ($existing_cost !== null) $existing_cost = (int)$existing_cost;
                if ($cost_price !== null) $cost_price = (int)$cost_price;
                if ($existing_cost !== $cost_price) $hasChanges = true;
                
                // jan_codeの比較
                if (($existing['jan_code'] ?? '') !== ($jan_code ?? '')) $hasChanges = true;
                
                // category_id, is_published, brand_idの比較
                $existing_category_id = $existing['category_id'] ?? null;
                if ($category_id !== null && $existing_category_id !== $category_id) $hasChanges = true;
                
                $existing_is_published = isset($existing['is_published']) ? (int)$existing['is_published'] : null;
                if ($is_published !== null && $existing_is_published !== $is_published) $hasChanges = true;
                
                $existing_brand_id = $existing['brand_id'] ?? null;
                if ($brand_id !== null && $existing_brand_id !== $brand_id) $hasChanges = true;
                
                // 変更があった場合のみ更新
                if ($hasChanges) {
                    if ($app_mode !== 'csv-writable') {
                    if ($hasStockUpdatedAt) {
                        // updated_atカラムが存在する場合
                        $stmt_update = $pdo->prepare("
                            UPDATE `{$stock_table}` 
                            SET stock_product_name = ?,
                                color_name = ?,
                                size_name = ?,
                                quantity = ?,
                                incoming_quantity_1 = ?,
                                incoming_date_1 = ?,
                                incoming_quantity_2 = ?,
                                incoming_date_2 = ?,
                                incoming_quantity_3 = ?,
                                incoming_date_3 = ?,
                                category_id = ?,
                                is_published = ?,
                                brand_id = ?,
                                list_price = ?,
                                cost_price = ?,
                                jan_code = ?,
                                updated_at = ?
                            WHERE id = ?
                        ");
                        $stmt_update->execute([
                            $product_name,
                            $color_name,
                            $size_name,
                            $stock_quantity,
                            $incoming_quantities[1] ?? null,
                            $incoming_dates[1] ?? null,
                            $incoming_quantities[2] ?? null,
                            $incoming_dates[2] ?? null,
                            $incoming_quantities[3] ?? null,
                            $incoming_dates[3] ?? null,
                            $category_id,
                            $is_published,
                            $brand_id,
                            $list_price,
                            $cost_price,
                            $jan_code,
                            $now,
                            $existing['id']
                        ]);
                    } else {
                        // updated_atカラムが存在しない場合
                        $stmt_update = $pdo->prepare("
                            UPDATE `{$stock_table}` 
                            SET stock_product_name = ?,
                                color_name = ?,
                                size_name = ?,
                                quantity = ?,
                                incoming_quantity_1 = ?,
                                incoming_date_1 = ?,
                                incoming_quantity_2 = ?,
                                incoming_date_2 = ?,
                                incoming_quantity_3 = ?,
                                incoming_date_3 = ?,
                                category_id = ?,
                                is_published = ?,
                                brand_id = ?,
                                list_price = ?,
                                cost_price = ?,
                                jan_code = ?
                            WHERE id = ?
                        ");
                        $stmt_update->execute([
                            $product_name,
                            $color_name,
                            $size_name,
                            $stock_quantity,
                            $incoming_quantities[1] ?? null,
                            $incoming_dates[1] ?? null,
                            $incoming_quantities[2] ?? null,
                            $incoming_dates[2] ?? null,
                            $incoming_quantities[3] ?? null,
                            $incoming_dates[3] ?? null,
                            $category_id,
                            $is_published,
                            $brand_id,
                            $list_price,
                            $cost_price,
                            $jan_code,
                            $existing['id']
                        ]);
                        }
                    } else {
                        // CSV書き込みモードでは、既存のレコードを更新
                        $existing_index = -1;
                        foreach ($csv_stock_data as $idx => $csv_row) {
                            if (($csv_row['id'] ?? '') === ($existing['id'] ?? '')) {
                                $existing_index = $idx;
                                break;
                            }
                        }
                        
                        $updated_row = [
                            'id' => $existing['id'] ?? $item_id,
                            'manufacturer_id' => $manufacturer_id,
                            'product_code' => $product_code,
                            'stock_product_name' => $product_name,
                            'color_code' => $color_code,
                            'color_name' => $color_name,
                            'size_code' => $size_code,
                            'size_name' => $size_name,
                            'quantity' => $stock_quantity,
                            'incoming_quantity_1' => $incoming_quantities[1] ?? null,
                            'incoming_date_1' => $incoming_dates[1] ?? null,
                            'incoming_quantity_2' => $incoming_quantities[2] ?? null,
                            'incoming_date_2' => $incoming_dates[2] ?? null,
                            'incoming_quantity_3' => $incoming_quantities[3] ?? null,
                            'incoming_date_3' => $incoming_dates[3] ?? null,
                            'category_id' => $category_id,
                            'is_published' => $is_published,
                            'brand_id' => $brand_id,
                            'list_price' => $list_price,
                            'cost_price' => $cost_price,
                            'jan_code' => $jan_code,
                            'created_at' => $existing['created_at'] ?? $now,
                            'updated_at' => $now
                        ];
                        
                        if ($existing_index >= 0) {
                            $csv_stock_data[$existing_index] = $updated_row;
                        } else {
                            $csv_stock_data[] = $updated_row;
                        }
                    }
                $summary['updatedStock']++;
                } else {
                    // 変更がない場合はスキップ
                    $summary['skippedUnchanged']++;
                }
            } else {
                // 新規レコードを挿入
                $item_id = 'stock_' . $manufacturer_id . '_' . $product_code . '_' . $color_code . '_' . $size_code;
                
                if ($app_mode !== 'csv-writable') {
                if ($hasStockCreatedAt && $hasStockUpdatedAt) {
                    // 両方のカラムが存在する場合
                    $stmt_insert = $pdo->prepare("
                        INSERT INTO `{$stock_table}` (
                            id, manufacturer_id, product_code, stock_product_name,
                            color_code, color_name, size_code, size_name,
                            quantity, incoming_quantity_1, incoming_date_1,
                            incoming_quantity_2, incoming_date_2,
                            incoming_quantity_3, incoming_date_3,
                            category_id, is_published, brand_id,
                            list_price, cost_price, jan_code, created_at, updated_at
                        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
                    ");
                    $stmt_insert->execute([
                        $item_id,
                        $manufacturer_id,
                        $product_code,
                        $product_name,
                        $color_code,
                        $color_name,
                        $size_code,
                        $size_name,
                        $stock_quantity,
                        $incoming_quantities[1] ?? null,
                        $incoming_dates[1] ?? null,
                        $incoming_quantities[2] ?? null,
                        $incoming_dates[2] ?? null,
                        $incoming_quantities[3] ?? null,
                        $incoming_dates[3] ?? null,
                        $category_id,
                        $is_published,
                        $brand_id,
                        $list_price,
                        $cost_price,
                        $jan_code,
                        $now,
                        $now
                    ]);
                } else {
                    // カラムが存在しない場合
                    $stmt_insert = $pdo->prepare("
                        INSERT INTO `{$stock_table}` (
                            id, manufacturer_id, product_code, stock_product_name,
                            color_code, color_name, size_code, size_name,
                            quantity, incoming_quantity_1, incoming_date_1,
                            incoming_quantity_2, incoming_date_2,
                            incoming_quantity_3, incoming_date_3,
                            category_id, is_published, brand_id,
                            list_price, cost_price, jan_code
                        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
                    ");
                    $stmt_insert->execute([
                        $item_id,
                        $manufacturer_id,
                        $product_code,
                        $product_name,
                        $color_code,
                        $color_name,
                        $size_code,
                        $size_name,
                        $stock_quantity,
                        $incoming_quantities[1] ?? null,
                        $incoming_dates[1] ?? null,
                        $incoming_quantities[2] ?? null,
                        $incoming_dates[2] ?? null,
                        $incoming_quantities[3] ?? null,
                        $incoming_dates[3] ?? null,
                        $category_id,
                        $is_published,
                        $brand_id,
                        $list_price,
                        $cost_price,
                        $jan_code
                    ]);
                    }
                } else {
                    // CSV書き込みモードでは、新しいレコードを配列に追加
                    $csv_stock_data[] = [
                        'id' => $item_id,
                        'manufacturer_id' => $manufacturer_id,
                        'product_code' => $product_code,
                        'stock_product_name' => $product_name,
                        'color_code' => $color_code,
                        'color_name' => $color_name,
                        'size_code' => $size_code,
                        'size_name' => $size_name,
                        'quantity' => $stock_quantity,
                        'incoming_quantity_1' => $incoming_quantities[1] ?? null,
                        'incoming_date_1' => $incoming_dates[1] ?? null,
                        'incoming_quantity_2' => $incoming_quantities[2] ?? null,
                        'incoming_date_2' => $incoming_dates[2] ?? null,
                        'incoming_quantity_3' => $incoming_quantities[3] ?? null,
                        'incoming_date_3' => $incoming_dates[3] ?? null,
                        'category_id' => $category_id,
                        'is_published' => $is_published,
                        'brand_id' => $brand_id,
                        'list_price' => $list_price,
                        'cost_price' => $cost_price,
                        'jan_code' => $jan_code,
                        'created_at' => $now,
                        'updated_at' => $now
                    ];
                }
                $summary['newItems']++;
                $summary['updatedStock']++;
            }
            
            // 注意: incoming_stockテーブルは削除（入荷情報はstockテーブルに直接保存）
            
            // --- 6. 商品関連テーブルにデータを登録（商品データ管理で必要） ---
            // 商品ID、カラーID、サイズIDを取得
            $product_id = "prod_{$manufacturer_id}_{$product_code}";
            $color_id = "color_{$manufacturer_id}_{$color_code}";
            $size_id = "size_{$manufacturer_id}_{$size_code}";
            
            // 注意: product_colorsは非推奨（stockテーブルから取得）
            
            // product_sizes: 商品とサイズの関連を登録
            $product_sizes_table = "product_sizes_{$manufacturer_id}";
            $product_size_id = "prod_size_{$manufacturer_id}_{$product_code}_{$size_code}";
            $stmt_product_size_check = $pdo->prepare("
                SELECT id FROM `{$product_sizes_table}` 
                WHERE product_id = ? AND size_id = ?
                LIMIT 1
            ");
            $stmt_product_size_check->execute([$product_id, $size_id]);
            if (!$stmt_product_size_check->fetch()) {
                $stmt_product_size_insert = $pdo->prepare("
                    INSERT INTO `{$product_sizes_table}` (id, manufacturer_id, product_id, size_id)
                    VALUES (?, ?, ?, ?)
                    ON DUPLICATE KEY UPDATE size_id = ?
                ");
                $stmt_product_size_insert->execute([$product_size_id, $manufacturer_id, $product_id, $size_id, $size_id]);
            }
            
            // product_color_sizes: 商品×カラー×サイズの関連を登録
            $product_color_sizes_table = "product_color_sizes_{$manufacturer_id}";
            $product_color_size_id = "prod_color_size_{$manufacturer_id}_{$product_code}_{$color_code}_{$size_code}";
            $stmt_product_color_size_check = $pdo->prepare("
                SELECT id FROM `{$product_color_sizes_table}` 
                WHERE product_id = ? AND color_id = ? AND size_id = ?
                LIMIT 1
            ");
            $stmt_product_color_size_check->execute([$product_id, $color_id, $size_id]);
            if (!$stmt_product_color_size_check->fetch()) {
                $stmt_product_color_size_insert = $pdo->prepare("
                    INSERT INTO `{$product_color_sizes_table}` (id, manufacturer_id, product_id, color_id, size_id)
                    VALUES (?, ?, ?, ?, ?)
                    ON DUPLICATE KEY UPDATE size_id = ?
                ");
                $stmt_product_color_size_insert->execute([$product_color_size_id, $manufacturer_id, $product_id, $color_id, $size_id, $size_id]);
            }
            
            // 注意: skusは非推奨（SKU情報はstockテーブルに含まれている）
            
            // 注意: product_pricesは非推奨（価格情報はstockテーブルに含まれている）

        } catch (Exception $e) {
            // skip_error_rowsがfalseの場合はエラーを投げる（トランザクションをロールバック）
            if (!$skip_error_rows) {
                $pdo->rollBack();
                http_response_code(500);
                echo json_encode([
                    'success' => false,
                    'message' => 'インポート処理中にエラーが発生しました',
                    'error' => $e->getMessage(),
                    'row' => $index + 2,
                    'debug_log' => $debug_mode ? $debug_log : null
                ], JSON_UNESCAPED_UNICODE);
                exit();
            }
            
            // エラーメッセージに詳細情報を追加
            $row_num = $index + 2;
            $error_message = sprintf(
                "[行 %d] %s (原因: %s, ファイル: %s, 行: %d)",
                $row_num,
                $e->getMessage(),
                $e->getCode() ?: '不明',
                basename($e->getFile()),
                $e->getLine()
            );
            $summary['errors'][] = $error_message;
            
            // 詳細なエラーログ
            logDebug("Row processing error (skipped)", [
                'row_number' => $row_num,
                'error_message' => $e->getMessage(),
                'error_code' => $e->getCode(),
                'file' => basename($e->getFile()),
                'line' => $e->getLine(),
                'row_data_sample' => $debug_mode ? array_slice($row, 0, 5, true) : null,
                'stack_trace' => $debug_mode ? $e->getTraceAsString() : null
            ], 'warning');
            
            // エラーを集約（同じメッセージの件数をカウント）
            $error_key = $e->getMessage();
            if (!isset($summary['errorSummary'][$error_key])) {
                $summary['errorSummary'][$error_key] = [
                    'message' => $e->getMessage(),
                    'count' => 0,
                    'rows' => [],
                    'location' => basename($e->getFile()) . ':' . $e->getLine()
                ];
            }
            $summary['errorSummary'][$error_key]['count']++;
            $summary['errorSummary'][$error_key]['rows'][] = $row_num;
            
            continue; // Skip to next row
        }
    }

    // CSV書き込みモードの場合は、データベースへの書き込みをスキップ
    if ($app_mode !== 'csv-writable') {
    $pdo->commit();
    } else {
        // CSV書き込みモードでは、データをCSVファイルに保存
        logDebug('CSV writable mode: Saving to CSV files', [
            'manufacturer_id' => $manufacturer_id,
            'stock_table' => $stock_table,
            'stock_rows' => count($csv_stock_data),
            'product_details_rows' => count($csv_product_details_map)
        ]);
        
        // stock CSVファイルを保存
        $stock_csv_path = getCsvPath("manu_{$manufacturer_id}_stock", $manufacturer_id);
        if ($stock_csv_path) {
            // ディレクトリが存在しない場合は作成
            $stock_dir = dirname($stock_csv_path);
            if (!is_dir($stock_dir)) {
                if (!mkdir($stock_dir, 0755, true)) {
                    throw new Exception('Failed to create directory: ' . $stock_dir);
                }
            }
            
            // ヘッダーを決定（最初のデータ行から取得、または標準的なヘッダーを使用）
            $stock_headers = [];
            if (!empty($csv_stock_data)) {
                $stock_headers = array_keys($csv_stock_data[0]);
            } else {
                // データがない場合は標準的なヘッダーを使用
                $stock_headers = [
                    'id', 'manufacturer_id', 'product_code', 'stock_product_name',
                    'color_code', 'color_name', 'size_code', 'size_name',
                    'quantity', 'incoming_quantity_1', 'incoming_date_1',
                    'incoming_quantity_2', 'incoming_date_2',
                    'incoming_quantity_3', 'incoming_date_3',
                    'category_id', 'is_published', 'brand_id',
                    'list_price', 'cost_price', 'jan_code', 'created_at', 'updated_at'
                ];
            }
            
            // CSVファイルを書き込み
            $stock_handle = fopen($stock_csv_path, 'w');
            if ($stock_handle === false) {
                throw new Exception('Failed to open stock CSV file for writing: ' . $stock_csv_path);
            }
            
            // BOMを出力（ExcelでUTF-8を正しく認識させるため）
            fwrite($stock_handle, "\xEF\xBB\xBF");
            
            // ヘッダー行を出力
            fputcsv($stock_handle, $stock_headers);
            
            // データ行を出力
            foreach ($csv_stock_data as $row) {
                $values = [];
                foreach ($stock_headers as $header) {
                    $value = $row[$header] ?? '';
                    if ($value === null) {
                        $value = '';
                    }
                    $values[] = $value;
                }
                fputcsv($stock_handle, $values);
            }
            
            fclose($stock_handle);
            logDebug('Saved stock CSV file', ['path' => $stock_csv_path, 'rows' => count($csv_stock_data)]);
        }
        
        // product_details CSVファイルを保存
        $details_csv_path = getCsvPath("manu_{$manufacturer_id}_details", $manufacturer_id);
        if ($details_csv_path) {
            // ディレクトリが存在しない場合は作成
            $details_dir = dirname($details_csv_path);
            if (!is_dir($details_dir)) {
                if (!mkdir($details_dir, 0755, true)) {
                    throw new Exception('Failed to create directory: ' . $details_dir);
                }
            }
            
            // product_detailsデータを配列に変換
            $csv_product_details_data = array_values($csv_product_details_map);
            
            // ヘッダーを決定
            $details_headers = [];
            if (!empty($csv_product_details_data)) {
                $details_headers = array_keys($csv_product_details_data[0]);
            } else {
                // データがない場合は標準的なヘッダーを使用
                $details_headers = [
                    'id', 'manufacturer_id', 'product_code', 'productName', 'product_name',
                    'description', 'images', 'tags', 'brand',
                    'meta_title', 'meta_description', 'og_image_url', 'og_title', 'og_description'
                ];
            }
            
            // CSVファイルを書き込み
            $details_handle = fopen($details_csv_path, 'w');
            if ($details_handle === false) {
                throw new Exception('Failed to open product_details CSV file for writing: ' . $details_csv_path);
            }
            
            // BOMを出力
            fwrite($details_handle, "\xEF\xBB\xBF");
            
            // ヘッダー行を出力
            fputcsv($details_handle, $details_headers);
            
            // データ行を出力
            foreach ($csv_product_details_data as $row) {
                $values = [];
                foreach ($details_headers as $header) {
                    $value = $row[$header] ?? '';
                    if ($value === null) {
                        $value = '';
                    }
                    $values[] = $value;
                }
                fputcsv($details_handle, $values);
            }
            
            fclose($details_handle);
            logDebug('Saved product_details CSV file', ['path' => $details_csv_path, 'rows' => count($csv_product_details_data)]);
        }
    }
    
    $message = "インポートが完了しました。";
    if (count($summary['errors']) > 0) {
        $error_count = count($summary['errors']);
        $unique_error_count = count($summary['errorSummary']);
        $message .= " {$error_count}件のエラーが発生しました（エラータイプ: {$unique_error_count}種類）。";
    }

    // エラーサマリーを整理（件数が多い順にソート）
    $error_summary_formatted = [];
    foreach ($summary['errorSummary'] as $error) {
        $rows_preview = count($error['rows']) > 10 
            ? implode(', ', array_slice($error['rows'], 0, 10)) . '... (他' . (count($error['rows']) - 10) . '件)'
            : implode(', ', $error['rows']);
        $error_summary_formatted[] = [
            'message' => $error['message'],
            'count' => $error['count'],
            'affected_rows' => $rows_preview,
            'location' => $error['location']
        ];
    }
    // 件数が多い順にソート
    usort($error_summary_formatted, function($a, $b) {
        return $b['count'] - $a['count'];
    });
    $summary['errorSummary'] = $error_summary_formatted;

    logDebug('Import completed successfully', [
        'summary' => $summary,
        'total_processed' => count($csv_data)
    ]);
    
    $response = [
        'success' => true,
        'message' => $message,
        'summary' => $summary
    ];
    
    // デバッグモードの場合はログも含める
    if ($debug_mode) {
        $response['debug_log'] = $debug_log;
        $response['validation'] = $validation_result;
    }
    
    echo json_encode($response, JSON_UNESCAPED_UNICODE);

} catch (Exception $e) {
    if (isset($pdo) && $pdo->inTransaction() && isset($app_mode) && $app_mode !== 'csv-writable') {
        $pdo->rollBack();
        logDebug('Transaction rolled back due to error', null, 'error');
    }
    
    // 詳細なエラーログ
    logDebug('Fatal error occurred', [
        'message' => $e->getMessage(),
        'code' => $e->getCode(),
        'file' => $e->getFile(),
        'line' => $e->getLine(),
        'trace' => $e->getTraceAsString()
    ], 'error');
    
    // エラーログを出力（デバッグ用）
    error_log('import-stock.php Error: ' . $e->getMessage());
    error_log('Stack trace: ' . $e->getTraceAsString());
    
    $error_response = [
        'success' => false, 
        'message' => 'データベース処理中に致命的なエラーが発生しました: ' . $e->getMessage(),
        'summary' => $summary ?? [],
        'error_details' => [
            'message' => $e->getMessage(),
            'code' => $e->getCode(),
            'file' => basename($e->getFile()),
            'full_path' => $e->getFile(),
            'line' => $e->getLine(),
            'trace' => array_map(function($trace) {
                return [
                    'file' => isset($trace['file']) ? basename($trace['file']) : 'N/A',
                    'line' => $trace['line'] ?? 'N/A',
                    'function' => $trace['function'] ?? 'N/A',
                    'class' => $trace['class'] ?? 'N/A'
                ];
            }, array_slice($e->getTrace(), 0, 10)) // 最初の10つのスタックトレース
        ]
    ];
    
    // デバッグモードの場合はログも含める
    if ($debug_mode) {
        $error_response['debug_log'] = $debug_log;
        if (isset($validation_result)) {
            $error_response['validation'] = $validation_result;
        }
    }
    
    http_response_code(500);
    echo json_encode($error_response, JSON_UNESCAPED_UNICODE);
    exit();
}

?>

                                category_id, is_published, brand_id,
                                list_price, cost_price, jan_code
                            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
                        ");
                        $stmt_insert->execute([
                            $item_id,
                            $manufacturer_id,
                            $product_code,
                            $product_name,
                            $color_code,
                            $color_name,
                            $size_code,
                            $size_name,
                            $stock_quantity,
                            $incoming_quantities[1] ?? null,
                            $incoming_dates[1] ?? null,
                            $incoming_quantities[2] ?? null,
                            $incoming_dates[2] ?? null,
                            $incoming_quantities[3] ?? null,
                            $incoming_dates[3] ?? null,
                            $category_id,
                            $is_published,
                            $brand_id,
                            $list_price,
                            $cost_price,
                            $jan_code
                        ]);
                    }
                } else {
                    // CSV書き込みモードでは、新しいレコードを配列に追加
                    $csv_stock_data[] = [
                        'id' => $item_id,
                        'manufacturer_id' => $manufacturer_id,
                        'product_code' => $product_code,
                        'stock_product_name' => $product_name,
                        'color_code' => $color_code,
                        'color_name' => $color_name,
                        'size_code' => $size_code,
                        'size_name' => $size_name,
                        'quantity' => $stock_quantity,
                        'incoming_quantity_1' => $incoming_quantities[1] ?? null,
                        'incoming_date_1' => $incoming_dates[1] ?? null,
                        'incoming_quantity_2' => $incoming_quantities[2] ?? null,
                        'incoming_date_2' => $incoming_dates[2] ?? null,
                        'incoming_quantity_3' => $incoming_quantities[3] ?? null,
                        'incoming_date_3' => $incoming_dates[3] ?? null,
                        'category_id' => $category_id,
                        'is_published' => $is_published,
                        'brand_id' => $brand_id,
                        'list_price' => $list_price,
                        'cost_price' => $cost_price,
                        'jan_code' => $jan_code,
                        'created_at' => $now,
                        'updated_at' => $now
                    ];
                }
                $summary['newItems']++;
                $summary['updatedStock']++;
            }
            
            // 注意: incoming_stockテーブルは削除（入荷情報はstockテーブルに直接保存）
            
            // --- 6. 商品関連テーブルにデータを登録（商品データ管理で必要） ---
            // 商品ID、カラーID、サイズIDを取得
            $product_id = "prod_{$manufacturer_id}_{$product_code}";
            $color_id = "color_{$manufacturer_id}_{$color_code}";
            $size_id = "size_{$manufacturer_id}_{$size_code}";
            
            // 注意: product_colorsは非推奨（stockテーブルから取得）
            
            // product_sizes: 商品とサイズの関連を登録
            $product_sizes_table = "product_sizes_{$manufacturer_id}";
            $product_size_id = "prod_size_{$manufacturer_id}_{$product_code}_{$size_code}";
            $stmt_product_size_check = $pdo->prepare("
                SELECT id FROM `{$product_sizes_table}` 
                WHERE product_id = ? AND size_id = ?
                LIMIT 1
            ");
            $stmt_product_size_check->execute([$product_id, $size_id]);
            if (!$stmt_product_size_check->fetch()) {
                $stmt_product_size_insert = $pdo->prepare("
                    INSERT INTO `{$product_sizes_table}` (id, manufacturer_id, product_id, size_id)
                    VALUES (?, ?, ?, ?)
                    ON DUPLICATE KEY UPDATE size_id = ?
                ");
                $stmt_product_size_insert->execute([$product_size_id, $manufacturer_id, $product_id, $size_id, $size_id]);
            }
            
            // product_color_sizes: 商品×カラー×サイズの関連を登録
            $product_color_sizes_table = "product_color_sizes_{$manufacturer_id}";
            $product_color_size_id = "prod_color_size_{$manufacturer_id}_{$product_code}_{$color_code}_{$size_code}";
            $stmt_product_color_size_check = $pdo->prepare("
                SELECT id FROM `{$product_color_sizes_table}` 
                WHERE product_id = ? AND color_id = ? AND size_id = ?
                LIMIT 1
            ");
            $stmt_product_color_size_check->execute([$product_id, $color_id, $size_id]);
            if (!$stmt_product_color_size_check->fetch()) {
                $stmt_product_color_size_insert = $pdo->prepare("
                    INSERT INTO `{$product_color_sizes_table}` (id, manufacturer_id, product_id, color_id, size_id)
                    VALUES (?, ?, ?, ?, ?)
                    ON DUPLICATE KEY UPDATE size_id = ?
                ");
                $stmt_product_color_size_insert->execute([$product_color_size_id, $manufacturer_id, $product_id, $color_id, $size_id, $size_id]);
            }
            
            // 注意: skusは非推奨（SKU情報はstockテーブルに含まれている）
            
            // 注意: product_pricesは非推奨（価格情報はstockテーブルに含まれている）

        } catch (Exception $e) {
            // skip_error_rowsがfalseの場合はエラーを投げる（トランザクションをロールバック）
            if (!$skip_error_rows) {
                $pdo->rollBack();
                http_response_code(500);
                echo json_encode([
                    'success' => false,
                    'message' => 'インポート処理中にエラーが発生しました',
                    'error' => $e->getMessage(),
                    'row' => $index + 2,
                    'debug_log' => $debug_mode ? $debug_log : null
                ], JSON_UNESCAPED_UNICODE);
                exit();
            }
            
            // エラーメッセージに詳細情報を追加
            $row_num = $index + 2;
            $error_message = sprintf(
                "[行 %d] %s (原因: %s, ファイル: %s, 行: %d)",
                $row_num,
                $e->getMessage(),
                $e->getCode() ?: '不明',
                basename($e->getFile()),
                $e->getLine()
            );
            $summary['errors'][] = $error_message;
            
            // 詳細なエラーログ
            logDebug("Row processing error (skipped)", [
                'row_number' => $row_num,
                'error_message' => $e->getMessage(),
                'error_code' => $e->getCode(),
                'file' => basename($e->getFile()),
                'line' => $e->getLine(),
                'row_data_sample' => $debug_mode ? array_slice($row, 0, 5, true) : null,
                'stack_trace' => $debug_mode ? $e->getTraceAsString() : null
            ], 'warning');
            
            // エラーを集約（同じメッセージの件数をカウント）
            $error_key = $e->getMessage();
            if (!isset($summary['errorSummary'][$error_key])) {
                $summary['errorSummary'][$error_key] = [
                    'message' => $e->getMessage(),
                    'count' => 0,
                    'rows' => [],
                    'location' => basename($e->getFile()) . ':' . $e->getLine()
                ];
            }
            $summary['errorSummary'][$error_key]['count']++;
            $summary['errorSummary'][$error_key]['rows'][] = $row_num;
            
            continue; // Skip to next row
        }
    }

    // CSV書き込みモードの場合は、データベースへの書き込みをスキップ
    if ($app_mode !== 'csv-writable') {
        $pdo->commit();
    } else {
        // CSV書き込みモードでは、データをCSVファイルに保存
        logDebug('CSV writable mode: Saving to CSV files', [
            'manufacturer_id' => $manufacturer_id,
            'stock_table' => $stock_table,
            'stock_rows' => count($csv_stock_data),
            'product_details_rows' => count($csv_product_details_map)
        ]);
        
        // stock CSVファイルを保存
        $stock_csv_path = getCsvPath("manu_{$manufacturer_id}_stock", $manufacturer_id);
        if ($stock_csv_path) {
            // ディレクトリが存在しない場合は作成
            $stock_dir = dirname($stock_csv_path);
            if (!is_dir($stock_dir)) {
                if (!mkdir($stock_dir, 0755, true)) {
                    throw new Exception('Failed to create directory: ' . $stock_dir);
                }
            }
            
            // ヘッダーを決定（最初のデータ行から取得、または標準的なヘッダーを使用）
            $stock_headers = [];
            if (!empty($csv_stock_data)) {
                $stock_headers = array_keys($csv_stock_data[0]);
            } else {
                // データがない場合は標準的なヘッダーを使用
                $stock_headers = [
                    'id', 'manufacturer_id', 'product_code', 'stock_product_name',
                    'color_code', 'color_name', 'size_code', 'size_name',
                    'quantity', 'incoming_quantity_1', 'incoming_date_1',
                    'incoming_quantity_2', 'incoming_date_2',
                    'incoming_quantity_3', 'incoming_date_3',
                    'category_id', 'is_published', 'brand_id',
                    'list_price', 'cost_price', 'jan_code', 'created_at', 'updated_at'
                ];
            }
            
            // CSVファイルを書き込み
            $stock_handle = fopen($stock_csv_path, 'w');
            if ($stock_handle === false) {
                throw new Exception('Failed to open stock CSV file for writing: ' . $stock_csv_path);
            }
            
            // BOMを出力（ExcelでUTF-8を正しく認識させるため）
            fwrite($stock_handle, "\xEF\xBB\xBF");
            
            // ヘッダー行を出力
            fputcsv($stock_handle, $stock_headers);
            
            // データ行を出力
            foreach ($csv_stock_data as $row) {
                $values = [];
                foreach ($stock_headers as $header) {
                    $value = $row[$header] ?? '';
                    if ($value === null) {
                        $value = '';
                    }
                    $values[] = $value;
                }
                fputcsv($stock_handle, $values);
            }
            
            fclose($stock_handle);
            logDebug('Saved stock CSV file', ['path' => $stock_csv_path, 'rows' => count($csv_stock_data)]);
        }
        
        // product_details CSVファイルを保存
        $details_csv_path = getCsvPath("manu_{$manufacturer_id}_details", $manufacturer_id);
        if ($details_csv_path) {
            // ディレクトリが存在しない場合は作成
            $details_dir = dirname($details_csv_path);
            if (!is_dir($details_dir)) {
                if (!mkdir($details_dir, 0755, true)) {
                    throw new Exception('Failed to create directory: ' . $details_dir);
                }
            }
            
            // product_detailsデータを配列に変換
            $csv_product_details_data = array_values($csv_product_details_map);
            
            // ヘッダーを決定
            $details_headers = [];
            if (!empty($csv_product_details_data)) {
                $details_headers = array_keys($csv_product_details_data[0]);
            } else {
                // データがない場合は標準的なヘッダーを使用
                $details_headers = [
                    'id', 'manufacturer_id', 'product_code', 'productName', 'product_name',
                    'description', 'images', 'tags', 'brand',
                    'meta_title', 'meta_description', 'og_image_url', 'og_title', 'og_description'
                ];
            }
            
            // CSVファイルを書き込み
            $details_handle = fopen($details_csv_path, 'w');
            if ($details_handle === false) {
                throw new Exception('Failed to open product_details CSV file for writing: ' . $details_csv_path);
            }
            
            // BOMを出力
            fwrite($details_handle, "\xEF\xBB\xBF");
            
            // ヘッダー行を出力
            fputcsv($details_handle, $details_headers);
            
            // データ行を出力
            foreach ($csv_product_details_data as $row) {
                $values = [];
                foreach ($details_headers as $header) {
                    $value = $row[$header] ?? '';
                    if ($value === null) {
                        $value = '';
                    }
                    $values[] = $value;
                }
                fputcsv($details_handle, $values);
            }
            
            fclose($details_handle);
            logDebug('Saved product_details CSV file', ['path' => $details_csv_path, 'rows' => count($csv_product_details_data)]);
        }
    }
    
    $message = "インポートが完了しました。";
    if (count($summary['errors']) > 0) {
        $error_count = count($summary['errors']);
        $unique_error_count = count($summary['errorSummary']);
        $message .= " {$error_count}件のエラーが発生しました（エラータイプ: {$unique_error_count}種類）。";
    }

    // エラーサマリーを整理（件数が多い順にソート）
    $error_summary_formatted = [];
    foreach ($summary['errorSummary'] as $error) {
        $rows_preview = count($error['rows']) > 10 
            ? implode(', ', array_slice($error['rows'], 0, 10)) . '... (他' . (count($error['rows']) - 10) . '件)'
            : implode(', ', $error['rows']);
        $error_summary_formatted[] = [
            'message' => $error['message'],
            'count' => $error['count'],
            'affected_rows' => $rows_preview,
            'location' => $error['location']
        ];
    }
    // 件数が多い順にソート
    usort($error_summary_formatted, function($a, $b) {
        return $b['count'] - $a['count'];
    });
    $summary['errorSummary'] = $error_summary_formatted;

    logDebug('Import completed successfully', [
        'summary' => $summary,
        'total_processed' => count($csv_data)
    ]);
    
    $response = [
        'success' => true,
        'message' => $message,
        'summary' => $summary
    ];
    
    // デバッグモードの場合はログも含める
    if ($debug_mode) {
        $response['debug_log'] = $debug_log;
        $response['validation'] = $validation_result;
    }
    
    echo json_encode($response, JSON_UNESCAPED_UNICODE);

} catch (Exception $e) {
    if (isset($pdo) && $pdo->inTransaction() && isset($app_mode) && $app_mode !== 'csv-writable') {
        $pdo->rollBack();
        logDebug('Transaction rolled back due to error', null, 'error');
    }
    
    // 詳細なエラーログ
    logDebug('Fatal error occurred', [
        'message' => $e->getMessage(),
        'code' => $e->getCode(),
        'file' => $e->getFile(),
        'line' => $e->getLine(),
        'trace' => $e->getTraceAsString()
    ], 'error');
    
    // エラーログを出力（デバッグ用）
    error_log('import-stock.php Error: ' . $e->getMessage());
    error_log('Stack trace: ' . $e->getTraceAsString());
    
    $error_response = [
        'success' => false, 
        'message' => 'データベース処理中に致命的なエラーが発生しました: ' . $e->getMessage(),
        'summary' => $summary ?? [],
        'error_details' => [
            'message' => $e->getMessage(),
            'code' => $e->getCode(),
            'file' => basename($e->getFile()),
            'full_path' => $e->getFile(),
            'line' => $e->getLine(),
            'trace' => array_map(function($trace) {
                return [
                    'file' => isset($trace['file']) ? basename($trace['file']) : 'N/A',
                    'line' => $trace['line'] ?? 'N/A',
                    'function' => $trace['function'] ?? 'N/A',
                    'class' => $trace['class'] ?? 'N/A'
                ];
            }, array_slice($e->getTrace(), 0, 10)) // 最初の10つのスタックトレース
        ]
    ];
    
    // デバッグモードの場合はログも含める
    if ($debug_mode) {
        $error_response['debug_log'] = $debug_log;
        if (isset($validation_result)) {
            $error_response['validation'] = $validation_result;
        }
    }
    
    http_response_code(500);
    echo json_encode($error_response, JSON_UNESCAPED_UNICODE);
    exit();
}

?>
